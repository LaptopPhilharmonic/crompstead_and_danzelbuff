"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Grid = exports.GridSquare = exports.GridId = void 0;
const typescript_helpers_js_1 = require("../util/typescript-helpers.js");
const import_manager_js_1 = require("../import-manager.js");
const pathfinder_js_1 = require("./pathfinder.js");
/** For managing data for grid-based game logic */
let nextGridId = 1;
const allGrids = {};
class GridId {
    constructor() {
        this.number = nextGridId;
        nextGridId += 1;
    }
}
exports.GridId = GridId;
class GridSquare {
    constructor(grid, x, y, walkable) {
        this.thingIds = [];
        this.gridId = grid.id;
        this.x = x;
        this.y = y;
        this.walkable = walkable;
        this.interactionKey = '';
        this.walkoverKey = '';
        this.refNumber = (y * grid.width) + x;
    }
    get parentGrid() {
        const parent = Grid.byId(this.gridId);
        if (!parent) {
            throw new Error('No parent Grid found for this GridSquare. How can this happen?');
        }
        return parent;
    }
    get isInteractable() {
        return this.interactionKey !== '';
    }
    get hasWalkover() {
        return this.walkoverKey !== '';
    }
    get things() {
        return (0, typescript_helpers_js_1.filterDefinitely)(this.thingIds.map((id) => import_manager_js_1.Thing.byId(id)));
    }
    get coordinates() {
        return { x: this.x, y: this.y };
    }
    /** Add a Thing to this square (if it isn't there already) */
    addThing(thing) {
        const id = thing instanceof import_manager_js_1.Thing ? thing.id : thing;
        if (!this.thingIds.includes(id)) {
            this.thingIds.push(id);
        }
    }
    /** Remove a Thing from this square if it's there */
    removeThing(thing) {
        const id = thing instanceof import_manager_js_1.Thing ? thing.id : thing;
        const thingIndex = this.thingIds.indexOf(id);
        if (thingIndex > -1) {
            this.thingIds.splice(thingIndex, 1);
        }
    }
    /** Get another square in this grid relative to this square. Negative numbers for up and left, positive for down and right */
    getRelativeNeighbour(relativeX, relativeY) {
        return this.parentGrid.getSquare(this.x + relativeX, this.y + relativeY);
    }
    getNeighbourAbove() {
        return this.getRelativeNeighbour(0, -1);
    }
    getNeighbourToRight() {
        return this.getRelativeNeighbour(1, 0);
    }
    getNeighbourBelow() {
        return this.getRelativeNeighbour(0, 1);
    }
    getNeighbourToLeft() {
        return this.getRelativeNeighbour(-1, 0);
    }
    getAllNeighbours() {
        const neighbours = [];
        const above = this.getNeighbourAbove();
        const below = this.getNeighbourBelow();
        const toLeft = this.getNeighbourToLeft();
        const toRight = this.getNeighbourToRight();
        if (above) {
            neighbours.push(above);
        }
        if (below) {
            neighbours.push(below);
        }
        if (toLeft) {
            neighbours.push(toLeft);
        }
        if (toRight) {
            neighbours.push(toRight);
        }
        return neighbours;
    }
}
exports.GridSquare = GridSquare;
class Grid {
    /** Pass it an array of strings like this:
     * 'XXX'
     * 'X-X'
     * 'XXX'
     * For quick auto-population of no-go squares
     *
     * X = No-go
     * - = Walkable
     *
     * Grid slots can contain an interactive element which you can supply as you like, and
     * you can edit the walkability of individual squares later on
    */
    constructor(basicLayout) {
        this.squaresArray = [];
        if (basicLayout.length === 0 || !basicLayout.every((row) => row.length === basicLayout[0].length)) {
            throw new Error('The grid should have at least one row, and all rows should be of the same length');
        }
        this.id = new GridId();
        this.width = basicLayout[0].length;
        this.height = basicLayout.length;
        this.squares = {};
        basicLayout.forEach((row, rowIndex) => {
            row.split('').forEach((column, columnIndex) => {
                const square = new GridSquare(this, columnIndex, rowIndex, column.toUpperCase() !== 'X');
                this.squares[`${columnIndex}-${rowIndex}`] = square;
                this.squaresArray.push(square);
            });
        });
        allGrids[this.id.number] = this;
    }
    getSquare(x, y) {
        return this.squares[`${x}-${y}`];
    }
    /** Remove a thing from all squares in this grid */
    removeThing(thing) {
        this.squaresArray.forEach((square) => square.removeThing(thing));
    }
    /** Use an algorithm to find a path from the first square to the second. Returns an empty array if it fails */
    findPath(from, to) {
        const fromSquare = this.getSquare(from.x, from.y);
        const toSquare = this.getSquare(to.x, to.y);
        if (fromSquare && toSquare) {
            return (0, pathfinder_js_1.getRoute)(fromSquare, toSquare);
        }
        else {
            return [];
        }
    }
    static byId(id) {
        return allGrids[id.number];
    }
}
exports.Grid = Grid;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3JpZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2dyaWQvR3JpZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5RUFBd0U7QUFDeEUsNERBQXNEO0FBQ3RELG1EQUEyQztBQUUzQyxrREFBa0Q7QUFFbEQsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO0FBQ25CLE1BQU0sUUFBUSxHQUEwQixFQUFFLENBQUM7QUFFM0MsTUFBYSxNQUFNO0lBR2Y7UUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQztRQUN6QixVQUFVLElBQUksQ0FBQyxDQUFDO0lBQ3BCLENBQUM7Q0FDSjtBQVBELHdCQU9DO0FBT0QsTUFBYSxVQUFVO0lBV25CLFlBQVksSUFBVSxFQUFFLENBQVMsRUFBRSxDQUFTLEVBQUUsUUFBaUI7UUFGdkQsYUFBUSxHQUFjLEVBQUUsQ0FBQztRQUc3QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDWCxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNYLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsSUFBSSxVQUFVO1FBQ1YsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsZ0VBQWdFLENBQUMsQ0FBQztTQUNyRjtRQUNELE9BQU8sTUFBTSxDQUFD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LEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMvQixDQUFDO0NBQ0o7QUEvREQsb0JBK0RDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWF5YmUsIGZpbHRlckRlZmluaXRlbHkgfSBmcm9tICcuLi91dGlsL3R5cGVzY3JpcHQtaGVscGVycy5qcyc7XHJcbmltcG9ydCB7IFRoaW5nSUQsIFRoaW5nIH0gZnJvbSAnLi4vaW1wb3J0LW1hbmFnZXIuanMnO1xyXG5pbXBvcnQgeyBnZXRSb3V0ZSB9IGZyb20gJy4vcGF0aGZpbmRlci5qcyc7XHJcblxyXG4vKiogRm9yIG1hbmFnaW5nIGRhdGEgZm9yIGdyaWQtYmFzZWQgZ2FtZSBsb2dpYyAqL1xyXG5cclxubGV0IG5leHRHcmlkSWQgPSAxO1xyXG5jb25zdCBhbGxHcmlkczoge1trZXk6IG51bWJlcl06IEdyaWR9ID0ge307XHJcblxyXG5leHBvcnQgY2xhc3MgR3JpZElkIHtcclxuICAgIG51bWJlcjogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMubnVtYmVyID0gbmV4dEdyaWRJZDtcclxuICAgICAgICBuZXh0R3JpZElkICs9IDE7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ29vcmRpbmF0ZXMge1xyXG4gICAgeDogbnVtYmVyO1xyXG4gICAgeTogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgR3JpZFNxdWFyZSB7XHJcbiAgICBwcml2YXRlIGdyaWRJZDogR3JpZElkO1xyXG4gICAgeDogbnVtYmVyO1xyXG4gICAgeTogbnVtYmVyO1xyXG4gICAgd2Fsa2FibGU6IGJvb2xlYW47XHJcbiAgICBpbnRlcmFjdGlvbktleTogc3RyaW5nO1xyXG4gICAgd2Fsa292ZXJLZXk6IHN0cmluZztcclxuICAgIC8qKiBUaGUgYWJzb2x1dGUgcmVmZXJlbmNlIG51bWJlciBmb3IgdGhpcyBzcXVhcmUgLSAoeSAqIHdpZHRoKSArIHggKi9cclxuICAgIHJlZk51bWJlcjogbnVtYmVyO1xyXG4gICAgcHJpdmF0ZSB0aGluZ0lkczogVGhpbmdJRFtdID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IoZ3JpZDogR3JpZCwgeDogbnVtYmVyLCB5OiBudW1iZXIsIHdhbGthYmxlOiBib29sZWFuKSB7XHJcbiAgICAgICAgdGhpcy5ncmlkSWQgPSBncmlkLmlkO1xyXG4gICAgICAgIHRoaXMueCA9IHg7XHJcbiAgICAgICAgdGhpcy55ID0geTtcclxuICAgICAgICB0aGlzLndhbGthYmxlID0gd2Fsa2FibGU7XHJcbiAgICAgICAgdGhpcy5pbnRlcmFjdGlvbktleSA9ICcnO1xyXG4gICAgICAgIHRoaXMud2Fsa292ZXJLZXkgPSAnJztcclxuICAgICAgICB0aGlzLnJlZk51bWJlciA9ICh5ICogZ3JpZC53aWR0aCkgKyB4O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBwYXJlbnRHcmlkKCk6IEdyaWQge1xyXG4gICAgICAgIGNvbnN0IHBhcmVudCA9IEdyaWQuYnlJZCh0aGlzLmdyaWRJZCk7XHJcbiAgICAgICAgaWYgKCFwYXJlbnQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBwYXJlbnQgR3JpZCBmb3VuZCBmb3IgdGhpcyBHcmlkU3F1YXJlLiBIb3cgY2FuIHRoaXMgaGFwcGVuPycpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcGFyZW50O1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBpc0ludGVyYWN0YWJsZSgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5pbnRlcmFjdGlvbktleSAhPT0gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGhhc1dhbGtvdmVyKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndhbGtvdmVyS2V5ICE9PSAnJztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdGhpbmdzKCk6IFRoaW5nW10ge1xyXG4gICAgICAgIHJldHVybiBmaWx0ZXJEZWZpbml0ZWx5KHRoaXMudGhpbmdJZHMubWFwKChpZCkgPT4gVGhpbmcuYnlJZChpZCkpKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY29vcmRpbmF0ZXMoKTogQ29vcmRpbmF0ZXMge1xyXG4gICAgICAgIHJldHVybiB7IHg6IHRoaXMueCwgeTogdGhpcy55IH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIEFkZCBhIFRoaW5nIHRvIHRoaXMgc3F1YXJlIChpZiBpdCBpc24ndCB0aGVyZSBhbHJlYWR5KSAqL1xyXG4gICAgYWRkVGhpbmcodGhpbmc6IFRoaW5nIHwgVGhpbmdJRCkge1xyXG4gICAgICAgIGNvbnN0IGlkID0gdGhpbmcgaW5zdGFuY2VvZiBUaGluZyA/IHRoaW5nLmlkIDogdGhpbmc7XHJcbiAgICAgICAgaWYgKCF0aGlzLnRoaW5nSWRzLmluY2x1ZGVzKGlkKSkge1xyXG4gICAgICAgICAgICB0aGlzLnRoaW5nSWRzLnB1c2goaWQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogUmVtb3ZlIGEgVGhpbmcgZnJvbSB0aGlzIHNxdWFyZSBpZiBpdCdzIHRoZXJlICovXHJcbiAgICByZW1vdmVUaGluZyh0aGluZzogVGhpbmcgfCBUaGluZ0lEKSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSB0aGluZyBpbnN0YW5jZW9mIFRoaW5nID8gdGhpbmcuaWQgOiB0aGluZztcclxuICAgICAgICBjb25zdCB0aGluZ0luZGV4ID0gdGhpcy50aGluZ0lkcy5pbmRleE9mKGlkKTtcclxuICAgICAgICBpZiAodGhpbmdJbmRleCA+IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMudGhpbmdJZHMuc3BsaWNlKHRoaW5nSW5kZXgsIDEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogR2V0IGFub3RoZXIgc3F1YXJlIGluIHRoaXMgZ3JpZCByZWxhdGl2ZSB0byB0aGlzIHNxdWFyZS4gTmVnYXRpdmUgbnVtYmVycyBmb3IgdXAgYW5kIGxlZnQsIHBvc2l0aXZlIGZvciBkb3duIGFuZCByaWdodCAqL1xyXG4gICAgZ2V0UmVsYXRpdmVOZWlnaGJvdXIocmVsYXRpdmVYOiBudW1iZXIsIHJlbGF0aXZlWTogbnVtYmVyKTogTWF5YmU8R3JpZFNxdWFyZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnBhcmVudEdyaWQuZ2V0U3F1YXJlKHRoaXMueCArIHJlbGF0aXZlWCwgdGhpcy55ICsgcmVsYXRpdmVZKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXROZWlnaGJvdXJBYm92ZSgpOiBNYXliZTxHcmlkU3F1YXJlPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UmVsYXRpdmVOZWlnaGJvdXIoMCwgLTEpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldE5laWdoYm91clRvUmlnaHQoKTogTWF5YmU8R3JpZFNxdWFyZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFJlbGF0aXZlTmVpZ2hib3VyKDEsIDApO1xyXG4gICAgfVxyXG5cclxuICAgIGdldE5laWdoYm91ckJlbG93KCk6IE1heWJlPEdyaWRTcXVhcmU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRSZWxhdGl2ZU5laWdoYm91cigwLCAxKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXROZWlnaGJvdXJUb0xlZnQoKTogTWF5YmU8R3JpZFNxdWFyZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFJlbGF0aXZlTmVpZ2hib3VyKC0xLCAwKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRBbGxOZWlnaGJvdXJzKCk6IEdyaWRTcXVhcmVbXSB7XHJcbiAgICAgICAgY29uc3QgbmVpZ2hib3VycyA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGFib3ZlID0gdGhpcy5nZXROZWlnaGJvdXJBYm92ZSgpO1xyXG4gICAgICAgIGNvbnN0IGJlbG93ID0gdGhpcy5nZXROZWlnaGJvdXJCZWxvdygpO1xyXG4gICAgICAgIGNvbnN0IHRvTGVmdCA9IHRoaXMuZ2V0TmVpZ2hib3VyVG9MZWZ0KCk7XHJcbiAgICAgICAgY29uc3QgdG9SaWdodCA9IHRoaXMuZ2V0TmVpZ2hib3VyVG9SaWdodCgpO1xyXG4gICAgICAgIGlmIChhYm92ZSkgeyBuZWlnaGJvdXJzLnB1c2goYWJvdmUpOyB9XHJcbiAgICAgICAgaWYgKGJlbG93KSB7IG5laWdoYm91cnMucHVzaChiZWxvdyk7IH1cclxuICAgICAgICBpZiAodG9MZWZ0KSB7IG5laWdoYm91cnMucHVzaCh0b0xlZnQpOyB9XHJcbiAgICAgICAgaWYgKHRvUmlnaHQpIHsgbmVpZ2hib3Vycy5wdXNoKHRvUmlnaHQpOyB9XHJcbiAgICAgICAgcmV0dXJuIG5laWdoYm91cnM7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBHcmlkIHtcclxuICAgIGlkOiBHcmlkSWQ7XHJcbiAgICB3aWR0aDogbnVtYmVyO1xyXG4gICAgaGVpZ2h0OiBudW1iZXI7XHJcbiAgICBzcXVhcmVzOiB7W2tleTogc3RyaW5nXTogR3JpZFNxdWFyZX07XHJcbiAgICBwcml2YXRlIHNxdWFyZXNBcnJheTogR3JpZFNxdWFyZVtdID0gW107XHJcblxyXG4gICAgLyoqIFBhc3MgaXQgYW4gYXJyYXkgb2Ygc3RyaW5ncyBsaWtlIHRoaXM6IFxyXG4gICAgICogJ1hYWCdcclxuICAgICAqICdYLVgnXHJcbiAgICAgKiAnWFhYJ1xyXG4gICAgICogRm9yIHF1aWNrIGF1dG8tcG9wdWxhdGlvbiBvZiBuby1nbyBzcXVhcmVzXHJcbiAgICAgKiBcclxuICAgICAqIFggPSBOby1nb1xyXG4gICAgICogLSA9IFdhbGthYmxlXHJcbiAgICAgKiBcclxuICAgICAqIEdyaWQgc2xvdHMgY2FuIGNvbnRhaW4gYW4gaW50ZXJhY3RpdmUgZWxlbWVudCB3aGljaCB5b3UgY2FuIHN1cHBseSBhcyB5b3UgbGlrZSwgYW5kXHJcbiAgICAgKiB5b3UgY2FuIGVkaXQgdGhlIHdhbGthYmlsaXR5IG9mIGluZGl2aWR1YWwgc3F1YXJlcyBsYXRlciBvblxyXG4gICAgKi9cclxuICAgIGNvbnN0cnVjdG9yKGJhc2ljTGF5b3V0OiBzdHJpbmdbXSkge1xyXG4gICAgICAgIGlmIChiYXNpY0xheW91dC5sZW5ndGggPT09IDAgfHwgIWJhc2ljTGF5b3V0LmV2ZXJ5KChyb3cpID0+IHJvdy5sZW5ndGggPT09IGJhc2ljTGF5b3V0WzBdLmxlbmd0aCkpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgZ3JpZCBzaG91bGQgaGF2ZSBhdCBsZWFzdCBvbmUgcm93LCBhbmQgYWxsIHJvd3Mgc2hvdWxkIGJlIG9mIHRoZSBzYW1lIGxlbmd0aCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5pZCA9IG5ldyBHcmlkSWQoKTtcclxuICAgICAgICB0aGlzLndpZHRoID0gYmFzaWNMYXlvdXRbMF0ubGVuZ3RoO1xyXG4gICAgICAgIHRoaXMuaGVpZ2h0ID0gYmFzaWNMYXlvdXQubGVuZ3RoO1xyXG4gICAgICAgIHRoaXMuc3F1YXJlcyA9IHt9O1xyXG5cclxuICAgICAgICBiYXNpY0xheW91dC5mb3JFYWNoKChyb3csIHJvd0luZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIHJvdy5zcGxpdCgnJykuZm9yRWFjaCgoY29sdW1uLCBjb2x1bW5JbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3F1YXJlID0gbmV3IEdyaWRTcXVhcmUodGhpcywgY29sdW1uSW5kZXgsIHJvd0luZGV4LCBjb2x1bW4udG9VcHBlckNhc2UoKSAhPT0gJ1gnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3F1YXJlc1tgJHtjb2x1bW5JbmRleH0tJHtyb3dJbmRleH1gXSA9IHNxdWFyZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3F1YXJlc0FycmF5LnB1c2goc3F1YXJlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGFsbEdyaWRzW3RoaXMuaWQubnVtYmVyXSA9IHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3F1YXJlKHg6IG51bWJlciwgeTogbnVtYmVyKTogTWF5YmU8R3JpZFNxdWFyZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNxdWFyZXNbYCR7eH0tJHt5fWBdO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiBSZW1vdmUgYSB0aGluZyBmcm9tIGFsbCBzcXVhcmVzIGluIHRoaXMgZ3JpZCAqL1xyXG4gICAgcmVtb3ZlVGhpbmcodGhpbmc6IFRoaW5nIHwgVGhpbmdJRCkge1xyXG4gICAgICAgIHRoaXMuc3F1YXJlc0FycmF5LmZvckVhY2goKHNxdWFyZSkgPT4gc3F1YXJlLnJlbW92ZVRoaW5nKHRoaW5nKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIFVzZSBhbiBhbGdvcml0aG0gdG8gZmluZCBhIHBhdGggZnJvbSB0aGUgZmlyc3Qgc3F1YXJlIHRvIHRoZSBzZWNvbmQuIFJldHVybnMgYW4gZW1wdHkgYXJyYXkgaWYgaXQgZmFpbHMgKi9cclxuICAgIGZpbmRQYXRoKGZyb206IENvb3JkaW5hdGVzLCB0bzogQ29vcmRpbmF0ZXMpOiBHcmlkU3F1YXJlW10ge1xyXG4gICAgICAgIGNvbnN0IGZyb21TcXVhcmUgPSB0aGlzLmdldFNxdWFyZShmcm9tLngsIGZyb20ueSk7XHJcbiAgICAgICAgY29uc3QgdG9TcXVhcmUgPSB0aGlzLmdldFNxdWFyZSh0by54LCB0by55KTtcclxuICAgICAgICBpZiAoZnJvbVNxdWFyZSAmJiB0b1NxdWFyZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZ2V0Um91dGUoZnJvbVNxdWFyZSwgdG9TcXVhcmUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGJ5SWQoaWQ6IEdyaWRJZCk6IE1heWJlPEdyaWQ+IHtcclxuICAgICAgICByZXR1cm4gYWxsR3JpZHNbaWQubnVtYmVyXTtcclxuICAgIH1cclxufSJdfQ==