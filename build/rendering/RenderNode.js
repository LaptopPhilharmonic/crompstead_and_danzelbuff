"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RenderNode = exports.Units = exports.RelativeTo = exports.RenderNodeID = void 0;
const import_manager_js_1 = require("../import-manager.js");
let nextId = 1;
/** All RenderNodes live here for lookup */
const allNodes = {};
class RenderNodeID {
    constructor() {
        this.number = nextId;
        nextId += 1;
    }
}
exports.RenderNodeID = RenderNodeID;
var RelativeTo;
(function (RelativeTo) {
    RelativeTo["scene"] = "scene";
    RelativeTo["parent"] = "parent";
    RelativeTo["camera"] = "camera";
})(RelativeTo = exports.RelativeTo || (exports.RelativeTo = {}));
var Units;
(function (Units) {
    Units["px"] = "px";
    Units["pc"] = "%";
})(Units = exports.Units || (exports.Units = {}));
class RenderNode {
    constructor(data) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q;
        /** Will not render if this is set to false */
        this.visible = true;
        this.id = new RenderNodeID();
        this.xx = (_a = data.x) !== null && _a !== void 0 ? _a : 0;
        this.xRelativeTo = (_b = data.xRelativeTo) !== null && _b !== void 0 ? _b : RelativeTo.scene;
        this.xUnit = (_c = data.xUnit) !== null && _c !== void 0 ? _c : Units.px;
        this.yy = (_d = data.y) !== null && _d !== void 0 ? _d : 0;
        this.yRelativeTo = (_e = data.yRelativeTo) !== null && _e !== void 0 ? _e : RelativeTo.scene;
        this.yUnit = (_f = data.yUnit) !== null && _f !== void 0 ? _f : Units.px;
        this.ww = (_g = data.w) !== null && _g !== void 0 ? _g : 0;
        this.wRelativeTo = (_h = data.wRelativeTo) !== null && _h !== void 0 ? _h : RelativeTo.scene;
        this.wUnit = (_j = data.wUnit) !== null && _j !== void 0 ? _j : Units.px;
        this.hh = (_k = data.h) !== null && _k !== void 0 ? _k : 0;
        this.hRelativeTo = (_l = data.hRelativeTo) !== null && _l !== void 0 ? _l : RelativeTo.scene;
        this.hUnit = (_m = data.hUnit) !== null && _m !== void 0 ? _m : Units.px;
        this.parentId = data.parent;
        this.children = (_o = data.children) !== null && _o !== void 0 ? _o : [];
        this.sceneId = data.scene;
        this.offsetX = (_p = data.offsetX) !== null && _p !== void 0 ? _p : 0;
        this.offsetY = (_q = data.offsetY) !== null && _q !== void 0 ? _q : 0;
        allNodes[this.id.number] = this;
    }
    get parent() {
        return this.parentId ? allNodes[this.parentId.number] : undefined;
    }
    set parent(p) {
        this.detach();
        if (p instanceof RenderNode) {
            this.parentId = p.id;
            p.addChild(this);
        }
        else {
            this.parentId = undefined;
        }
    }
    /** Removes this RenderNode from its parent and Scene */
    detach() {
        var _a;
        if (this.parent) {
            this.parent.removeChild(this);
        }
        if (this.sceneId) {
            (_a = this.scene) === null || _a === void 0 ? void 0 : _a.removeRenderNode(this);
        }
    }
    /** All these properties have code in common to deal with unit types and relativity to parents */
    getXYWH(setting) {
        const nn = setting + setting; // Hidden variable names for these are always double the character
        const orientation = (setting === 'x' || setting === 'w') ? 'w' : 'h';
        const relativeTo = this[setting + 'RelativeTo'];
        const unit = this[setting + 'Unit'];
        switch (relativeTo) {
            case RelativeTo.scene:
                if (!this.scene) {
                    console.error(this);
                    throw new Error(`RenderNode with id ${this.id.number} is not in a Scene but is position relative to scene`);
                }
                if (unit === Units.px) {
                    return this[nn];
                }
                else if (unit === Units.pc) {
                    return this.scene[orientation] * this[nn];
                }
            case RelativeTo.camera:
                return this[nn]; // The renderer will handle where to put this
            case RelativeTo.parent:
                if (this.parent) {
                    if (unit === Units.px) {
                        return this.parent[setting] + this[nn];
                    }
                    else if (unit === Units.pc) {
                        return this.parent[orientation] * this[nn];
                    }
                }
                else {
                    if (!this.scene) {
                        console.error(this);
                        throw new Error(`RenderNode with id ${this.id.number} is not in a Scene, and has no parent, but is positioned relative to parent`);
                    }
                    if (unit === Units.px) {
                        return this[nn];
                    }
                    else if (unit === Units.pc) {
                        return this.scene[orientation] * this[nn];
                    }
                }
            default:
                return this[nn];
        }
    }
    setXYWH(setting, value, unit, relativeTo) {
        const nn = setting + setting; // Hidden variable names for these are always double the character
        this[nn] = value;
        if (unit) {
            this[setting + 'Unit'] = unit;
        }
        if (relativeTo) {
            this[setting + 'RelativeTo'] = relativeTo;
        }
    }
    get x() {
        return this.getXYWH('x');
    }
    setX(x, unit, relativeTo) {
        this.setXYWH('x', x, unit, relativeTo);
    }
    get y() {
        return this.getXYWH('y');
    }
    setY(y, unit, relativeTo) {
        this.setXYWH('y', y, unit, relativeTo);
    }
    get w() {
        return this.getXYWH('w');
    }
    set w(w) {
        this.ww = w;
    }
    setW(w, unit, relativeTo) {
        this.setXYWH('w', w, unit, relativeTo);
    }
    get h() {
        return this.getXYWH('h');
    }
    set h(h) {
        this.hh = h;
    }
    setH(h, unit, relativeTo) {
        this.setXYWH('h', h, unit, relativeTo);
    }
    /** Adds the node as a child of this node, removing any parent relationship it already has. Returns same node for chaining. */
    addChild(child) {
        if (child instanceof RenderNode) {
            if (!this.children.find((c) => c.number === child.id.number)) {
                child.detach();
                this.children.push(child.id);
                child.parent = this;
            }
        }
        else {
            throw new TypeError('children must be supplied as RenderNode or RenderNodeID');
        }
        return child;
    }
    removeChild(child) {
        const index = this.children.findIndex((c) => c.number === child.id.number);
        if (index > -1) {
            this.children.splice(index, 1);
        }
        child.parentId = undefined;
    }
    isParentOf(child) {
        return !!this.children.find((c) => c.number === child.number);
    }
    /** Looks recursively to parent nodes to establish what Scene this RenderNode is in */
    get scene() {
        var _a;
        if (this.parentId) {
            return (_a = this.parent) === null || _a === void 0 ? void 0 : _a.scene;
        }
        const possibleScene = import_manager_js_1.Scene.byId(this.sceneId);
        return import_manager_js_1.Scene.byId(this.sceneId);
    }
    /** Should only be set on top-level RenderNodes (attached directly to a Scene). Children inherit from the parent. Will throw errors otherwise */
    set scene(scene) {
        if (this.parentId) {
            throw new Error(`This RenderNode has a parent and should not have its Scene changed directly.`);
        }
        if (scene instanceof import_manager_js_1.Scene) {
            this.sceneId = scene.id;
        }
        else {
            this.sceneId = undefined;
        }
    }
    get hasChildren() {
        return this.children.length > 0;
    }
    forEachChild(fn) {
        this.children.forEach((childID) => {
            const possibleChild = RenderNode.byId(childID);
            if (possibleChild) {
                fn(possibleChild);
            }
        });
    }
    /** Remove all references to this RenderNode and any of its children which would otherwise be floating around */
    delete() {
        this.forEachChild((child) => child.delete());
        this.detach();
        delete allNodes[this.id.number];
    }
    static byId(id) {
        return allNodes[id.number];
    }
}
exports.RenderNode = RenderNode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVuZGVyTm9kZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3JlbmRlcmluZy9SZW5kZXJOb2RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDREQUFzRDtBQUd0RCxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFFZiwyQ0FBMkM7QUFDM0MsTUFBTSxRQUFRLEdBQWdDLEVBQUUsQ0FBQztBQUVqRCxNQUFhLFlBQVk7SUFHckI7UUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixNQUFNLElBQUksQ0FBQyxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQVBELG9DQU9DO0FBRUQsSUFBWSxVQUlYO0FBSkQsV0FBWSxVQUFVO0lBQ2xCLDZCQUFlLENBQUE7SUFDZiwrQkFBaUIsQ0FBQTtJQUNqQiwrQkFBaUIsQ0FBQTtBQUNyQixDQUFDLEVBSlcsVUFBVSxHQUFWLGtCQUFVLEtBQVYsa0JBQVUsUUFJckI7QUFFRCxJQUFZLEtBR1g7QUFIRCxXQUFZLEtBQUs7SUFDYixrQkFBUyxDQUFBO0lBQ1QsaUJBQVEsQ0FBQTtBQUNaLENBQUMsRUFIVyxLQUFLLEdBQUwsYUFBSyxLQUFMLGFBQUssUUFHaEI7QUF5Q0QsTUFBYSxVQUFVO0lBOEJuQixZQUFZLElBQW9COztRQUhoQyw4Q0FBOEM7UUFDOUMsWUFBTyxHQUFZLElBQUksQ0FBQztRQUdwQixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFBLElBQUksQ0FBQyxDQUFDLG1DQUFJLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxHQUFHLE1BQUEsSUFBSSxDQUFDLFdBQVcsbUNBQUksVUFBVSxDQUFDLEtBQUssQ0FBQztRQUN4RCxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQUEsSUFBSSxDQUFDLEtBQUssbUNBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMs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ZW5lLCBTY2VuZUlEIH0gZnJvbSAnLi4vaW1wb3J0LW1hbmFnZXIuanMnO1xyXG5pbXBvcnQgeyBJbmRleGFibGVDbGFzcywgTWF5YmUsIGRlZmluaXRlbHkgfSBmcm9tICcuLi91dGlsL3R5cGVzY3JpcHQtaGVscGVycy5qcyc7XHJcblxyXG5sZXQgbmV4dElkID0gMTtcclxuXHJcbi8qKiBBbGwgUmVuZGVyTm9kZXMgbGl2ZSBoZXJlIGZvciBsb29rdXAgKi9cclxuY29uc3QgYWxsTm9kZXM6IHtba2V5OiBudW1iZXJdOiBSZW5kZXJOb2RlfSA9IHt9O1xyXG5cclxuZXhwb3J0IGNsYXNzIFJlbmRlck5vZGVJRCB7XHJcbiAgICBudW1iZXI6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLm51bWJlciA9IG5leHRJZDtcclxuICAgICAgICBuZXh0SWQgKz0gMTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGVudW0gUmVsYXRpdmVUbyB7XHJcbiAgICBzY2VuZSA9ICdzY2VuZScsXHJcbiAgICBwYXJlbnQgPSAncGFyZW50JyxcclxuICAgIGNhbWVyYSA9ICdjYW1lcmEnLFxyXG59XHJcblxyXG5leHBvcnQgZW51bSBVbml0cyB7XHJcbiAgICBweCA9ICdweCcsXHJcbiAgICBwYyA9ICclJyxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZW5kZXJOb2RlRGF0YSB7XHJcbiAgICAvKiogRGVmYXVsdDogMCAqL1xyXG4gICAgeD86IE1heWJlPG51bWJlcj47XHJcbiAgICAvKiogRGVmYXVsdDogc2NlbmUgKi9cclxuICAgIHhSZWxhdGl2ZVRvPzogUmVsYXRpdmVUbztcclxuICAgIC8qKiBEZWZhdWx0OiBweCAqL1xyXG4gICAgeFVuaXQ/OiBVbml0cztcclxuXHJcbiAgICAvKiogRGVmYXVsdDogMCAqL1xyXG4gICAgeT86IE1heWJlPG51bWJlcj47XHJcbiAgICAvKiogRGVmYXVsdDogc2NlbmUgKi9cclxuICAgIHlSZWxhdGl2ZVRvPzogUmVsYXRpdmVUbztcclxuICAgIC8qKiBEZWZhdWx0OiBweCAqLyAgICBcclxuICAgIHlVbml0PzogVW5pdHM7XHJcblxyXG4gICAgLyoqIERlZmF1bHQ6IDAgKi9cclxuICAgIHc/OiBNYXliZTxudW1iZXI+O1xyXG4gICAgLyoqIERlZmF1bHQ6IHNjZW5lICovXHJcbiAgICB3UmVsYXRpdmVUbz86IFJlbGF0aXZlVG87XHJcbiAgICAvKiogRGVmYXVsdDogcHggKi9cclxuICAgIHdVbml0PzogVW5pdHM7XHJcblxyXG4gICAgLyoqIERlZmF1bHQ6IDAgKi9cclxuICAgIGg/OiBNYXliZTxudW1iZXI+O1xyXG4gICAgLyoqIERlZmF1bHQ6IHNjZW5lICovICAgIFxyXG4gICAgaFJlbGF0aXZlVG8/OiBSZWxhdGl2ZVRvO1xyXG4gICAgLyoqIERlZmF1bHQ6IHB4ICovICAgIFxyXG4gICAgaFVuaXQ/OiBVbml0cztcclxuXHJcbiAgICBwYXJlbnQ/OiBSZW5kZXJOb2RlSUQ7XHJcbiAgICBjaGlsZHJlbj86IFJlbmRlck5vZGVJRFtdO1xyXG4gICAgc2NlbmU/OiBTY2VuZUlEO1xyXG5cclxuICAgIC8qKiBIb3cgbWFueSBwaXhlbHMgdG8gYWRkIChvciBzdWJ0cmFjdCkgd2hlbiBwb3NpdGlvbmluZyB0aGlzIFJlbmRlck5vZGUgKi9cclxuICAgIG9mZnNldFg/OiBudW1iZXI7XHJcbiAgICAvKiogSG93IG1hbnkgcGl4ZWxzIHRvIGFkZCAob3Igc3VidHJhY3QpIHdoZW4gcG9zaXRpb25pbmcgdGhpcyBSZW5kZXJOb2RlICovXHJcbiAgICBvZmZzZXRZPzogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUmVuZGVyTm9kZSBpbXBsZW1lbnRzIEluZGV4YWJsZUNsYXNzIHtcclxuICAgIGlkOiBSZW5kZXJOb2RlSUQ7XHJcbiAgICBba2V5OiBzdHJpbmddOiBhbnk7XHJcblxyXG4gICAgcHJpdmF0ZSB4eDogbnVtYmVyO1xyXG4gICAgeFVuaXQ6IFVuaXRzO1xyXG4gICAgeFJlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcblxyXG4gICAgcHJpdmF0ZSB5eTogbnVtYmVyO1xyXG4gICAgeVVuaXQ6IFVuaXRzO1xyXG4gICAgeVJlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcblxyXG4gICAgcHJpdmF0ZSB3dzogbnVtYmVyO1xyXG4gICAgd1JlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcbiAgICB3VW5pdDogVW5pdHM7XHJcblxyXG4gICAgcHJpdmF0ZSBoaDogbnVtYmVyO1xyXG4gICAgaFJlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcbiAgICBoVW5pdDogVW5pdHM7XHJcblxyXG4gICAgcHJpdmF0ZSBzY2VuZUlkPzogU2NlbmVJRDtcclxuICAgIHByaXZhdGUgcGFyZW50SWQ/OiBSZW5kZXJOb2RlSUQ7XHJcbiAgICBjaGlsZHJlbjogUmVuZGVyTm9kZUlEW107XHJcblxyXG4gICAgb2Zmc2V0WDogbnVtYmVyO1xyXG4gICAgb2Zmc2V0WTogbnVtYmVyO1xyXG5cclxuICAgIC8qKiBXaWxsIG5vdCByZW5kZXIgaWYgdGhpcyBpcyBzZXQgdG8gZmFsc2UgKi9cclxuICAgIHZpc2libGU6IGJvb2xlYW4gPSB0cnVlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGRhdGE6IFJlbmRlck5vZGVEYXRhKSB7XHJcbiAgICAgICAgdGhpcy5pZCA9IG5ldyBSZW5kZXJOb2RlSUQoKTtcclxuICAgICAgICB0aGlzLnh4ID0gZGF0YS54ID8/IDA7XHJcbiAgICAgICAgdGhpcy54UmVsYXRpdmVUbyA9IGRhdGEueFJlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLnhVbml0ID0gZGF0YS54VW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLnl5ID0gZGF0YS55ID8/IDA7XHJcbiAgICAgICAgdGhpcy55UmVsYXRpdmVUbyA9IGRhdGEueVJlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLnlVbml0ID0gZGF0YS55VW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLnd3ID0gZGF0YS53ID8/IDA7XHJcbiAgICAgICAgdGhpcy53UmVsYXRpdmVUbyA9IGRhdGEud1JlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLndVbml0ID0gZGF0YS53VW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLmhoID0gZGF0YS5oID8/IDA7XHJcbiAgICAgICAgdGhpcy5oUmVsYXRpdmVUbyA9IGRhdGEuaFJlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLmhVbml0ID0gZGF0YS5oVW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLnBhcmVudElkID0gZGF0YS5wYXJlbnQ7XHJcbiAgICAgICAgdGhpcy5jaGlsZHJlbiA9IGRhdGEuY2hpbGRyZW4gPz8gW107XHJcbiAgICAgICAgdGhpcy5zY2VuZUlkID0gZGF0YS5zY2VuZTtcclxuICAgICAgICB0aGlzLm9mZnNldFggPSBkYXRhLm9mZnNldFggPz8gMDtcclxuICAgICAgICB0aGlzLm9mZnNldFkgPSBkYXRhLm9mZnNldFkgPz8gMDtcclxuXHJcbiAgICAgICAgYWxsTm9kZXNbdGhpcy5pZC5udW1iZXJdID0gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcGFyZW50KCk6IE1heWJlPFJlbmRlck5vZGU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnRJZCA/IGFsbE5vZGVzW3RoaXMucGFyZW50SWQubnVtYmVyXSA6IHVuZGVmaW5lZDtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgcGFyZW50KHA6IE1heWJlPFJlbmRlck5vZGU+KSB7XHJcbiAgICAgICAgdGhpcy5kZXRhY2goKTtcclxuICAgICAgICBpZiAocCBpbnN0YW5jZW9mIFJlbmRlck5vZGUpIHtcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRJZCA9IHAuaWQ7XHJcbiAgICAgICAgICAgIHAuYWRkQ2hpbGQodGhpcyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnRJZCA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIFJlbW92ZXMgdGhpcyBSZW5kZXJOb2RlIGZyb20gaXRzIHBhcmVudCBhbmQgU2NlbmUgKi9cclxuICAgIGRldGFjaCgpIHtcclxuICAgICAgICBpZiAodGhpcy5wYXJlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5wYXJlbnQucmVtb3ZlQ2hpbGQodGhpcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnNjZW5lSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5zY2VuZT8ucmVtb3ZlUmVuZGVyTm9kZSh0aGlzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIEFsbCB0aGVzZSBwcm9wZXJ0aWVzIGhhdmUgY29kZSBpbiBjb21tb24gdG8gZGVhbCB3aXRoIHVuaXQgdHlwZXMgYW5kIHJlbGF0aXZpdHkgdG8gcGFyZW50cyAqL1xyXG4gICAgcHJpdmF0ZSBnZXRYWVdIKHNldHRpbmc6ICd4JyB8ICd5JyB8ICd3JyB8ICdoJyk6IG51bWJlciB7XHJcbiAgICAgICAgY29uc3Qgbm4gPSBzZXR0aW5nICsgc2V0dGluZzsgLy8gSGlkZGVuIHZhcmlhYmxlIG5hbWVzIGZvciB0aGVzZSBhcmUgYWx3YXlzIGRvdWJsZSB0aGUgY2hhcmFjdGVyXHJcbiAgICAgICAgY29uc3Qgb3JpZW50YXRpb24gPSAoc2V0dGluZyA9PT0gJ3gnIHx8IHNldHRpbmcgPT09ICd3JykgPyAndycgOiAnaCc7XHJcbiAgICAgICAgY29uc3QgcmVsYXRpdmVUbyA9IHRoaXNbc2V0dGluZyArICdSZWxhdGl2ZVRvJ10gYXMgUmVsYXRpdmVUbztcclxuICAgICAgICBjb25zdCB1bml0ID0gdGhpc1tzZXR0aW5nICsgJ1VuaXQnXSBhcyBVbml0cztcclxuXHJcbiAgICAgICAgc3dpdGNoIChyZWxhdGl2ZVRvKSB7XHJcbiAgICAgICAgICAgIGNhc2UgUmVsYXRpdmVUby5zY2VuZTpcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5zY2VuZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IodGhpcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZW5kZXJOb2RlIHdpdGggaWQgJHt0aGlzLmlkLm51bWJlcn0gaXMgbm90IGluIGEgU2NlbmUgYnV0IGlzIHBvc2l0aW9uIHJlbGF0aXZlIHRvIHNjZW5lYCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAodW5pdCA9PT0gVW5pdHMucHgpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tubl07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVuaXQgPT09IFVuaXRzLnBjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NlbmVbb3JpZW50YXRpb25dICogdGhpc1tubl07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgUmVsYXRpdmVUby5jYW1lcmE6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tubl07IC8vIFRoZSByZW5kZXJlciB3aWxsIGhhbmRsZSB3aGVyZSB0byBwdXQgdGhpc1xyXG4gICAgICAgICAgICBjYXNlIFJlbGF0aXZlVG8ucGFyZW50OlxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVuaXQgPT09IFVuaXRzLnB4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudFtzZXR0aW5nXSArIHRoaXNbbm5dO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodW5pdCA9PT0gVW5pdHMucGMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50W29yaWVudGF0aW9uXSAqIHRoaXNbbm5dO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnNjZW5lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IodGhpcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVuZGVyTm9kZSB3aXRoIGlkICR7dGhpcy5pZC5udW1iZXJ9IGlzIG5vdCBpbiBhIFNjZW5lLCBhbmQgaGFzIG5vIHBhcmVudCwgYnV0IGlzIHBvc2l0aW9uZWQgcmVsYXRpdmUgdG8gcGFyZW50YCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1bml0ID09PSBVbml0cy5weCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tubl07XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1bml0ID09PSBVbml0cy5wYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zY2VuZVtvcmllbnRhdGlvbl0gKiB0aGlzW25uXTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tubl0gYXMgbnVtYmVyO1xyXG4gICAgICAgIH0gICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZXRYWVdIKHNldHRpbmc6ICd4JyB8ICd5JyB8ICd3JyB8ICdoJywgdmFsdWU6IG51bWJlciwgdW5pdD86IFVuaXRzLCByZWxhdGl2ZVRvPzogUmVsYXRpdmVUbykge1xyXG4gICAgICAgIGNvbnN0IG5uID0gc2V0dGluZyArIHNldHRpbmc7IC8vIEhpZGRlbiB2YXJpYWJsZSBuYW1lcyBmb3IgdGhlc2UgYXJlIGFsd2F5cyBkb3VibGUgdGhlIGNoYXJhY3RlclxyXG4gICAgICAgIHRoaXNbbm5dID0gdmFsdWU7XHJcbiAgICAgICAgaWYgKHVuaXQpIHtcclxuICAgICAgICAgICAgdGhpc1tzZXR0aW5nICsgJ1VuaXQnXSA9IHVuaXQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyZWxhdGl2ZVRvKSB7XHJcbiAgICAgICAgICAgIHRoaXNbc2V0dGluZyArICdSZWxhdGl2ZVRvJ10gPSByZWxhdGl2ZVRvO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgeCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFhZV0goJ3gnKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRYKHg6IG51bWJlciwgdW5pdD86IFVuaXRzLCByZWxhdGl2ZVRvPzogUmVsYXRpdmVUbykge1xyXG4gICAgICAgIHRoaXMuc2V0WFlXSCgneCcsIHgsIHVuaXQsIHJlbGF0aXZlVG8pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCB5KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0WFlXSCgneScpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFkoeTogbnVtYmVyLCB1bml0PzogVW5pdHMsIHJlbGF0aXZlVG8/OiBSZWxhdGl2ZVRvKSB7XHJcbiAgICAgICAgdGhpcy5zZXRYWVdIKCd5JywgeSwgdW5pdCwgcmVsYXRpdmVUbyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHcoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRYWVdIKCd3Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IHcodzogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy53dyA9IHc7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0Vyh3OiBudW1iZXIsIHVuaXQ/OiBVbml0cywgcmVsYXRpdmVUbz86IFJlbGF0aXZlVG8pIHtcclxuICAgICAgICB0aGlzLnNldFhZV0goJ3cnLCB3LCB1bml0LCByZWxhdGl2ZVRvKTsgICAgICAgIFxyXG4gICAgfVxyXG5cclxuICAgIGdldCBoKCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0WFlXSCgnaCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldCBoKGg6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuaGggPSBoO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEgoaDogbnVtYmVyLCB1bml0PzogVW5pdHMsIHJlbGF0aXZlVG8/OiBSZWxhdGl2ZVRvKSB7XHJcbiAgICAgICAgdGhpcy5zZXRYWVdIKCdoJywgaCwgdW5pdCwgcmVsYXRpdmVUbyk7ICAgICAgICBcclxuICAgIH1cclxuXHJcbiAgICAvKiogQWRkcyB0aGUgbm9kZSBhcyBhIGNoaWxkIG9mIHRoaXMgbm9kZSwgcmVtb3ZpbmcgYW55IHBhcmVudCByZWxhdGlvbnNoaXAgaXQgYWxyZWFkeSBoYXMuIFJldHVybnMgc2FtZSBub2RlIGZvciBjaGFpbmluZy4gKi9cclxuICAgIGFkZENoaWxkKGNoaWxkOiBSZW5kZXJOb2RlKTogUmVuZGVyTm9kZSB7XHJcbiAgICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgUmVuZGVyTm9kZSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY2hpbGRyZW4uZmluZCgoYykgPT4gYy5udW1iZXIgPT09IGNoaWxkLmlkLm51bWJlcikpIHtcclxuICAgICAgICAgICAgICAgIGNoaWxkLmRldGFjaCgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkLmlkKTtcclxuICAgICAgICAgICAgICAgIGNoaWxkLnBhcmVudCA9IHRoaXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdjaGlsZHJlbiBtdXN0IGJlIHN1cHBsaWVkIGFzIFJlbmRlck5vZGUgb3IgUmVuZGVyTm9kZUlEJyk7ICAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjaGlsZDtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVDaGlsZChjaGlsZDogUmVuZGVyTm9kZSkge1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5jaGlsZHJlbi5maW5kSW5kZXgoKGMpID0+IGMubnVtYmVyID09PSBjaGlsZC5pZC5udW1iZXIpO1xyXG4gICAgICAgIGlmIChpbmRleCA+IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAxKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY2hpbGQucGFyZW50SWQgPSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgaXNQYXJlbnRPZihjaGlsZDogUmVuZGVyTm9kZSk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhIXRoaXMuY2hpbGRyZW4uZmluZCgoYykgPT4gYy5udW1iZXIgPT09IGNoaWxkLm51bWJlcik7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIExvb2tzIHJlY3Vyc2l2ZWx5IHRvIHBhcmVudCBub2RlcyB0byBlc3RhYmxpc2ggd2hhdCBTY2VuZSB0aGlzIFJlbmRlck5vZGUgaXMgaW4gKi9cclxuICAgIGdldCBzY2VuZSgpOiBNYXliZTxTY2VuZT4ge1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudElkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudD8uc2NlbmU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBvc3NpYmxlU2NlbmUgPSBTY2VuZS5ieUlkKHRoaXMuc2NlbmVJZCk7XHJcbiAgICAgICAgcmV0dXJuIFNjZW5lLmJ5SWQodGhpcy5zY2VuZUlkKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogU2hvdWxkIG9ubHkgYmUgc2V0IG9uIHRvcC1sZXZlbCBSZW5kZXJOb2RlcyAoYXR0YWNoZWQgZGlyZWN0bHkgdG8gYSBTY2VuZSkuIENoaWxkcmVuIGluaGVyaXQgZnJvbSB0aGUgcGFyZW50LiBXaWxsIHRocm93IGVycm9ycyBvdGhlcndpc2UgKi9cclxuICAgIHNldCBzY2VuZShzY2VuZTogTWF5YmU8U2NlbmU+KSB7XHJcbiAgICAgICAgaWYgKHRoaXMucGFyZW50SWQpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGlzIFJlbmRlck5vZGUgaGFzIGEgcGFyZW50IGFuZCBzaG91bGQgbm90IGhhdmUgaXRzIFNjZW5lIGNoYW5nZWQgZGlyZWN0bHkuYClcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNjZW5lIGluc3RhbmNlb2YgU2NlbmUpIHtcclxuICAgICAgICAgICAgdGhpcy5zY2VuZUlkID0gc2NlbmUuaWQ7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zY2VuZUlkID0gdW5kZWZpbmVkO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgaGFzQ2hpbGRyZW4oKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gMDtcclxuICAgIH1cclxuXHJcbiAgICBmb3JFYWNoQ2hpbGQoZm46IChjaGlsZE5vZGU6IFJlbmRlck5vZGUpID0+IHZvaWQpIHtcclxuICAgICAgICB0aGlzLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkSUQpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcG9zc2libGVDaGlsZCA9IFJlbmRlck5vZGUuYnlJZChjaGlsZElEKTtcclxuICAgICAgICAgICAgaWYgKHBvc3NpYmxlQ2hpbGQpIHtcclxuICAgICAgICAgICAgICAgIGZuKHBvc3NpYmxlQ2hpbGQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIFJlbW92ZSBhbGwgcmVmZXJlbmNlcyB0byB0aGlzIFJlbmRlck5vZGUgYW5kIGFueSBvZiBpdHMgY2hpbGRyZW4gd2hpY2ggd291bGQgb3RoZXJ3aXNlIGJlIGZsb2F0aW5nIGFyb3VuZCAqL1xyXG4gICAgZGVsZXRlKCkge1xyXG4gICAgICAgIHRoaXMuZm9yRWFjaENoaWxkKChjaGlsZCkgPT4gY2hpbGQuZGVsZXRlKCkpO1xyXG4gICAgICAgIHRoaXMuZGV0YWNoKCk7XHJcbiAgICAgICAgZGVsZXRlIGFsbE5vZGVzW3RoaXMuaWQubnVtYmVyXTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgYnlJZChpZDogUmVuZGVyTm9kZUlEKTogUmVuZGVyTm9kZSB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiBhbGxOb2Rlc1tpZC5udW1iZXJdO1xyXG4gICAgfVxyXG59Il19