"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RenderNode = exports.Units = exports.RelativeTo = exports.RenderNodeID = void 0;
const import_manager_js_1 = require("../import-manager.js");
let nextId = 1;
/** All RenderNodes live here for lookup */
const allNodes = {};
class RenderNodeID {
    constructor() {
        this.number = nextId;
        nextId += 1;
    }
}
exports.RenderNodeID = RenderNodeID;
var RelativeTo;
(function (RelativeTo) {
    RelativeTo["scene"] = "scene";
    RelativeTo["parent"] = "parent";
    RelativeTo["camera"] = "camera";
})(RelativeTo = exports.RelativeTo || (exports.RelativeTo = {}));
var Units;
(function (Units) {
    Units["px"] = "px";
    Units["pc"] = "%";
})(Units = exports.Units || (exports.Units = {}));
class RenderNode {
    constructor(data) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q;
        this.id = new RenderNodeID();
        this.xx = (_a = data.x) !== null && _a !== void 0 ? _a : 0;
        this.xRelativeTo = (_b = data.xRelativeTo) !== null && _b !== void 0 ? _b : RelativeTo.scene;
        this.xUnit = (_c = data.xUnit) !== null && _c !== void 0 ? _c : Units.px;
        this.yy = (_d = data.y) !== null && _d !== void 0 ? _d : 0;
        this.yRelativeTo = (_e = data.yRelativeTo) !== null && _e !== void 0 ? _e : RelativeTo.scene;
        this.yUnit = (_f = data.yUnit) !== null && _f !== void 0 ? _f : Units.px;
        this.ww = (_g = data.w) !== null && _g !== void 0 ? _g : 0;
        this.wRelativeTo = (_h = data.wRelativeTo) !== null && _h !== void 0 ? _h : RelativeTo.scene;
        this.wUnit = (_j = data.wUnit) !== null && _j !== void 0 ? _j : Units.px;
        this.hh = (_k = data.h) !== null && _k !== void 0 ? _k : 0;
        this.hRelativeTo = (_l = data.hRelativeTo) !== null && _l !== void 0 ? _l : RelativeTo.scene;
        this.hUnit = (_m = data.hUnit) !== null && _m !== void 0 ? _m : Units.px;
        this.parentId = data.parent;
        this.children = (_o = data.children) !== null && _o !== void 0 ? _o : [];
        this.sceneId = data.scene;
        this.offsetX = (_p = data.offsetX) !== null && _p !== void 0 ? _p : 0;
        this.offsetY = (_q = data.offsetY) !== null && _q !== void 0 ? _q : 0;
        allNodes[this.id.number] = this;
    }
    get parent() {
        return this.parentId ? allNodes[this.parentId.number] : null;
    }
    set parent(p) {
        if (p instanceof RenderNode) {
            this.parentId = p.id;
            if (p.children.includes(this.id)) {
                p.children.push(this.id);
            }
        }
        else if (p instanceof RenderNodeID) {
            const parentNode = allNodes[p.number];
            if (parentNode) {
                this.parent = p;
                parentNode.addChild(this);
            }
            else {
                throw new Error(`No RenderNode found with id ${p.number}`);
            }
        }
        else {
            throw new TypeError('parent can only be set to a RenderNode or a RenderNodeID');
        }
    }
    /** All these properties have code in common to deal with unit types and relativity to parents */
    getXYWH(setting) {
        const nn = setting + setting; // Hidden variable names for these are always double the character
        const orientation = (setting === 'x' || setting === 'w') ? 'w' : 'h';
        const relativeTo = this[setting + 'RelativeTo'];
        const unit = this[setting + 'Unit'];
        if (!this.scene) {
            throw new Error(`RenderNode with id ${this.id.number} is not in a Scene`);
        }
        switch (relativeTo) {
            case RelativeTo.scene:
                if (unit === Units.px) {
                    return this[nn];
                }
                else if (unit === Units.pc) {
                    return this.scene[orientation] * this[nn];
                }
            case RelativeTo.camera:
                return this[nn]; // The renderer will handle where to put this
            case RelativeTo.parent:
                if (this.parent) {
                    if (unit === Units.px) {
                        return this.parent[setting] + this[nn];
                    }
                    else if (unit === Units.pc) {
                        return this.parent[orientation] * this[nn];
                    }
                }
                else {
                    if (unit === Units.px) {
                        return this[nn];
                    }
                    else if (unit === Units.pc) {
                        return this.scene[orientation] * this[nn];
                    }
                }
            default:
                return this[nn];
        }
    }
    setXYWH(setting, value, unit, relativeTo) {
        const nn = setting + setting; // Hidden variable names for these are always double the character
        this[nn] = value;
        if (unit) {
            this[setting + 'Unit'] = unit;
        }
        if (relativeTo) {
            this[setting + 'RelativeTo'] = relativeTo;
        }
    }
    get x() {
        return this.getXYWH('x');
    }
    setX(x, unit, relativeTo) {
        this.setXYWH('x', x, unit, relativeTo);
    }
    get y() {
        return this.getXYWH('y');
    }
    setY(y, unit, relativeTo) {
        this.setXYWH('y', y, unit, relativeTo);
    }
    get w() {
        return this.getXYWH('w');
    }
    set w(w) {
        this.ww = w;
    }
    setW(w, unit, relativeTo) {
        this.setXYWH('w', w, unit, relativeTo);
    }
    get h() {
        return this.getXYWH('h');
    }
    set h(h) {
        this.hh = h;
    }
    setH(h, unit, relativeTo) {
        this.setXYWH('h', h, unit, relativeTo);
    }
    addChild(child) {
        if (child instanceof RenderNode) {
            if (!this.children.includes(child.id)) {
                this.children.push(child.id);
                child.parent = this;
            }
        }
        else if (child instanceof RenderNodeID) {
            const childNode = allNodes[child.number];
            if (childNode && !this.children.includes(child)) {
                this.children.push(child);
                childNode.parent = this;
            }
            else if (!childNode) {
                throw new Error(`No RenderNode found with id ${child.number}`);
            }
        }
        else {
            throw new TypeError('children must be supplied as RenderNode or RenderNodeID');
        }
    }
    removeChild(child) {
        if (!(child instanceof RenderNode || child instanceof RenderNodeID)) {
            throw new TypeError('children must be supplied as RenderNode or RenderNodeID');
        }
        const childId = child instanceof RenderNodeID ? child : child.id;
        const index = this.children.indexOf(childId);
        if (index > -1) {
            this.children = this.children.splice(index, 1);
        }
    }
    /** Looks recursively to parent nodes to establish what Scene this RenderNode is in */
    get scene() {
        var _a;
        if (this.parentId) {
            return (_a = this.parent) === null || _a === void 0 ? void 0 : _a.scene;
        }
        const possibleScene = import_manager_js_1.Scene.byId(this.sceneId);
        return import_manager_js_1.Scene.byId(this.sceneId);
    }
    /** Should only be set on top-level RenderNodes (attached directly to a Scene). Children inherit from the parent. Will throw errors otherwise */
    set scene(scene) {
        if (this.parentId) {
            throw new Error(`This RenderNode has a parent and should not have its Scene changed directly.`);
        }
        if (scene instanceof import_manager_js_1.Scene) {
            this.sceneId = scene.id;
        }
        else if (scene instanceof import_manager_js_1.SceneID) {
            this.sceneId = scene;
        }
        else {
            this.sceneId = undefined;
        }
    }
    get hasChildren() {
        return this.children.length > 0;
    }
    forEachChild(fn) {
        this.children.forEach((childID) => {
            const possibleChild = RenderNode.byId(childID);
            if (possibleChild) {
                fn(possibleChild);
            }
        });
    }
    /** Remove all references to this RenderNode and any of its children which would otherwise be floating around */
    delete() {
        var _a, _b;
        this.forEachChild((child) => child.delete());
        (_a = this.parent) === null || _a === void 0 ? void 0 : _a.removeChild(this);
        (_b = this.scene) === null || _b === void 0 ? void 0 : _b.removeRenderNode(this);
        delete allNodes[this.id.number];
    }
    static byId(id) {
        return allNodes[id.number];
    }
}
exports.RenderNode = RenderNode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVuZGVyTm9kZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3JlbmRlcmluZy9SZW5kZXJOb2RlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDREQUFzRDtBQUd0RCxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFFZiwyQ0FBMkM7QUFDM0MsTUFBTSxRQUFRLEdBQWdDLEVBQUUsQ0FBQztBQUVqRCxNQUFhLFlBQVk7SUFHckI7UUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixNQUFNLElBQUksQ0FBQyxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQVBELG9DQU9DO0FBRUQsSUFBWSxVQUlYO0FBSkQsV0FBWSxVQUFVO0lBQ2xCLDZCQUFlLENBQUE7SUFDZiwrQkFBaUIsQ0FBQTtJQUNqQiwrQkFBaUIsQ0FBQTtBQUNyQixDQUFDLEVBSlcsVUFBVSxHQUFWLGtCQUFVLEtBQVYsa0JBQVUsUUFJckI7QUFFRCxJQUFZLEtBR1g7QUFIRCxXQUFZLEtBQUs7SUFDYixrQkFBUyxDQUFBO0lBQ1QsaUJBQVEsQ0FBQTtBQUNaLENBQUMsRUFIVyxLQUFLLEdBQUwsYUFBSyxLQUFMLGFBQUssUUFHaEI7QUF5Q0QsTUFBYSxVQUFVO0lBMkJuQixZQUFZLElBQW9COztRQUM1QixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLEVBQUUsR0FBRyxNQUFBLElBQUksQ0FBQyxDQUFDLG1DQUFJLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxHQUFHLE1BQUEsSUFBSSxDQUFDLFdBQVcsbUNBQUksVUFBVSxDQUFDLEtBQUssQ0FBQztRQUN4RCxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQUEsSUFBSSxDQUFDLEtBQUssbUNBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsRUFBRSxHQUFHLE1BQUEsSUFBSSxDQUFDLENBQUMsbUNBQUksQ0FB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QUFDLEtBQUssMENBQUUsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFnQjtRQUN4QixPQUFPLFFBQVEsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0IsQ0FBQztDQUNKO0FBaFBELGdDQWdQQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNjZW5lLCBTY2VuZUlEIH0gZnJvbSAnLi4vaW1wb3J0LW1hbmFnZXIuanMnO1xyXG5pbXBvcnQgeyBJbmRleGFibGVDbGFzcywgTWF5YmUgfSBmcm9tICcuLi91dGlsL3R5cGVzY3JpcHQtaGVscGVycy5qcyc7XHJcblxyXG5sZXQgbmV4dElkID0gMTtcclxuXHJcbi8qKiBBbGwgUmVuZGVyTm9kZXMgbGl2ZSBoZXJlIGZvciBsb29rdXAgKi9cclxuY29uc3QgYWxsTm9kZXM6IHtba2V5OiBudW1iZXJdOiBSZW5kZXJOb2RlfSA9IHt9O1xyXG5cclxuZXhwb3J0IGNsYXNzIFJlbmRlck5vZGVJRCB7XHJcbiAgICBudW1iZXI6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLm51bWJlciA9IG5leHRJZDtcclxuICAgICAgICBuZXh0SWQgKz0gMTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGVudW0gUmVsYXRpdmVUbyB7XHJcbiAgICBzY2VuZSA9ICdzY2VuZScsXHJcbiAgICBwYXJlbnQgPSAncGFyZW50JyxcclxuICAgIGNhbWVyYSA9ICdjYW1lcmEnLFxyXG59XHJcblxyXG5leHBvcnQgZW51bSBVbml0cyB7XHJcbiAgICBweCA9ICdweCcsXHJcbiAgICBwYyA9ICclJyxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZW5kZXJOb2RlRGF0YSB7XHJcbiAgICAvKiogRGVmYXVsdDogMCAqL1xyXG4gICAgeD86IE1heWJlPG51bWJlcj47XHJcbiAgICAvKiogRGVmYXVsdDogc2NlbmUgKi9cclxuICAgIHhSZWxhdGl2ZVRvPzogUmVsYXRpdmVUbztcclxuICAgIC8qKiBEZWZhdWx0OiBweCAqL1xyXG4gICAgeFVuaXQ/OiBVbml0cztcclxuXHJcbiAgICAvKiogRGVmYXVsdDogMCAqL1xyXG4gICAgeT86IE1heWJlPG51bWJlcj47XHJcbiAgICAvKiogRGVmYXVsdDogc2NlbmUgKi9cclxuICAgIHlSZWxhdGl2ZVRvPzogUmVsYXRpdmVUbztcclxuICAgIC8qKiBEZWZhdWx0OiBweCAqLyAgICBcclxuICAgIHlVbml0PzogVW5pdHM7XHJcblxyXG4gICAgLyoqIERlZmF1bHQ6IDAgKi9cclxuICAgIHc/OiBNYXliZTxudW1iZXI+O1xyXG4gICAgLyoqIERlZmF1bHQ6IHNjZW5lICovXHJcbiAgICB3UmVsYXRpdmVUbz86IFJlbGF0aXZlVG87XHJcbiAgICAvKiogRGVmYXVsdDogcHggKi9cclxuICAgIHdVbml0PzogVW5pdHM7XHJcblxyXG4gICAgLyoqIERlZmF1bHQ6IDAgKi9cclxuICAgIGg/OiBNYXliZTxudW1iZXI+O1xyXG4gICAgLyoqIERlZmF1bHQ6IHNjZW5lICovICAgIFxyXG4gICAgaFJlbGF0aXZlVG8/OiBSZWxhdGl2ZVRvO1xyXG4gICAgLyoqIERlZmF1bHQ6IHB4ICovICAgIFxyXG4gICAgaFVuaXQ/OiBVbml0cztcclxuXHJcbiAgICBwYXJlbnQ/OiBSZW5kZXJOb2RlSUQ7XHJcbiAgICBjaGlsZHJlbj86IFJlbmRlck5vZGVJRFtdO1xyXG4gICAgc2NlbmU/OiBTY2VuZUlEO1xyXG5cclxuICAgIC8qKiBIb3cgbWFueSBwaXhlbHMgdG8gYWRkIChvciBzdWJ0cmFjdCkgd2hlbiBwb3NpdGlvbmluZyB0aGlzIFJlbmRlck5vZGUgKi9cclxuICAgIG9mZnNldFg/OiBudW1iZXI7XHJcbiAgICAvKiogSG93IG1hbnkgcGl4ZWxzIHRvIGFkZCAob3Igc3VidHJhY3QpIHdoZW4gcG9zaXRpb25pbmcgdGhpcyBSZW5kZXJOb2RlICovXHJcbiAgICBvZmZzZXRZPzogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUmVuZGVyTm9kZSBpbXBsZW1lbnRzIEluZGV4YWJsZUNsYXNzIHtcclxuICAgIGlkOiBSZW5kZXJOb2RlSUQ7XHJcbiAgICBba2V5OiBzdHJpbmddOiBhbnk7XHJcblxyXG4gICAgcHJpdmF0ZSB4eDogbnVtYmVyO1xyXG4gICAgeFVuaXQ6IFVuaXRzO1xyXG4gICAgeFJlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcblxyXG4gICAgcHJpdmF0ZSB5eTogbnVtYmVyO1xyXG4gICAgeVVuaXQ6IFVuaXRzO1xyXG4gICAgeVJlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcblxyXG4gICAgcHJpdmF0ZSB3dzogbnVtYmVyO1xyXG4gICAgd1JlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcbiAgICB3VW5pdDogVW5pdHM7XHJcblxyXG4gICAgcHJpdmF0ZSBoaDogbnVtYmVyO1xyXG4gICAgaFJlbGF0aXZlVG86IFJlbGF0aXZlVG87XHJcbiAgICBoVW5pdDogVW5pdHM7XHJcblxyXG4gICAgcHJpdmF0ZSBzY2VuZUlkPzogU2NlbmVJRDtcclxuICAgIHByaXZhdGUgcGFyZW50SWQ/OiBSZW5kZXJOb2RlSUQ7XHJcbiAgICBjaGlsZHJlbjogUmVuZGVyTm9kZUlEW107XHJcblxyXG4gICAgb2Zmc2V0WDogbnVtYmVyO1xyXG4gICAgb2Zmc2V0WTogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGRhdGE6IFJlbmRlck5vZGVEYXRhKSB7XHJcbiAgICAgICAgdGhpcy5pZCA9IG5ldyBSZW5kZXJOb2RlSUQoKTtcclxuICAgICAgICB0aGlzLnh4ID0gZGF0YS54ID8/IDA7XHJcbiAgICAgICAgdGhpcy54UmVsYXRpdmVUbyA9IGRhdGEueFJlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLnhVbml0ID0gZGF0YS54VW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLnl5ID0gZGF0YS55ID8/IDA7XHJcbiAgICAgICAgdGhpcy55UmVsYXRpdmVUbyA9IGRhdGEueVJlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLnlVbml0ID0gZGF0YS55VW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLnd3ID0gZGF0YS53ID8/IDA7XHJcbiAgICAgICAgdGhpcy53UmVsYXRpdmVUbyA9IGRhdGEud1JlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLndVbml0ID0gZGF0YS53VW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLmhoID0gZGF0YS5oID8/IDA7XHJcbiAgICAgICAgdGhpcy5oUmVsYXRpdmVUbyA9IGRhdGEuaFJlbGF0aXZlVG8gPz8gUmVsYXRpdmVUby5zY2VuZTtcclxuICAgICAgICB0aGlzLmhVbml0ID0gZGF0YS5oVW5pdCA/PyBVbml0cy5weDtcclxuICAgICAgICB0aGlzLnBhcmVudElkID0gZGF0YS5wYXJlbnQ7XHJcbiAgICAgICAgdGhpcy5jaGlsZHJlbiA9IGRhdGEuY2hpbGRyZW4gPz8gW107XHJcbiAgICAgICAgdGhpcy5zY2VuZUlkID0gZGF0YS5zY2VuZTtcclxuICAgICAgICB0aGlzLm9mZnNldFggPSBkYXRhLm9mZnNldFggPz8gMDtcclxuICAgICAgICB0aGlzLm9mZnNldFkgPSBkYXRhLm9mZnNldFkgPz8gMDtcclxuXHJcbiAgICAgICAgYWxsTm9kZXNbdGhpcy5pZC5udW1iZXJdID0gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBnZXQgcGFyZW50KCk6IFJlbmRlck5vZGUgfCBudWxsIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnRJZCA/IGFsbE5vZGVzW3RoaXMucGFyZW50SWQubnVtYmVyXSA6IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IHBhcmVudChwOiBSZW5kZXJOb2RlIHwgUmVuZGVyTm9kZUlEIHwgbnVsbCkge1xyXG4gICAgICAgIGlmIChwIGluc3RhbmNlb2YgUmVuZGVyTm9kZSkge1xyXG4gICAgICAgICAgICB0aGlzLnBhcmVudElkID0gcC5pZDtcclxuICAgICAgICAgICAgaWYgKHAuY2hpbGRyZW4uaW5jbHVkZXModGhpcy5pZCkpIHtcclxuICAgICAgICAgICAgICAgIHAuY2hpbGRyZW4ucHVzaCh0aGlzLmlkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAocCBpbnN0YW5jZW9mIFJlbmRlck5vZGVJRCkge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbnROb2RlID0gYWxsTm9kZXNbcC5udW1iZXJdO1xyXG4gICAgICAgICAgICBpZiAocGFyZW50Tm9kZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wYXJlbnQgPSBwO1xyXG4gICAgICAgICAgICAgICAgcGFyZW50Tm9kZS5hZGRDaGlsZCh0aGlzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTm8gUmVuZGVyTm9kZSBmb3VuZCB3aXRoIGlkICR7cC5udW1iZXJ9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdwYXJlbnQgY2FuIG9ubHkgYmUgc2V0IHRvIGEgUmVuZGVyTm9kZSBvciBhIFJlbmRlck5vZGVJRCcpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogQWxsIHRoZXNlIHByb3BlcnRpZXMgaGF2ZSBjb2RlIGluIGNvbW1vbiB0byBkZWFsIHdpdGggdW5pdCB0eXBlcyBhbmQgcmVsYXRpdml0eSB0byBwYXJlbnRzICovXHJcbiAgICBwcml2YXRlIGdldFhZV0goc2V0dGluZzogJ3gnIHwgJ3knIHwgJ3cnIHwgJ2gnKTogbnVtYmVyIHtcclxuICAgICAgICBjb25zdCBubiA9IHNldHRpbmcgKyBzZXR0aW5nOyAvLyBIaWRkZW4gdmFyaWFibGUgbmFtZXMgZm9yIHRoZXNlIGFyZSBhbHdheXMgZG91YmxlIHRoZSBjaGFyYWN0ZXJcclxuICAgICAgICBjb25zdCBvcmllbnRhdGlvbiA9IChzZXR0aW5nID09PSAneCcgfHwgc2V0dGluZyA9PT0gJ3cnKSA/ICd3JyA6ICdoJztcclxuICAgICAgICBjb25zdCByZWxhdGl2ZVRvID0gdGhpc1tzZXR0aW5nICsgJ1JlbGF0aXZlVG8nXSBhcyBSZWxhdGl2ZVRvO1xyXG4gICAgICAgIGNvbnN0IHVuaXQgPSB0aGlzW3NldHRpbmcgKyAnVW5pdCddIGFzIFVuaXRzO1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMuc2NlbmUpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZW5kZXJOb2RlIHdpdGggaWQgJHt0aGlzLmlkLm51bWJlcn0gaXMgbm90IGluIGEgU2NlbmVgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHN3aXRjaCAocmVsYXRpdmVUbykge1xyXG4gICAgICAgICAgICBjYXNlIFJlbGF0aXZlVG8uc2NlbmU6XHJcbiAgICAgICAgICAgICAgICBpZiAodW5pdCA9PT0gVW5pdHMucHgpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tubl07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVuaXQgPT09IFVuaXRzLnBjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NlbmVbb3JpZW50YXRpb25dICogdGhpc1tubl07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2UgUmVsYXRpdmVUby5jYW1lcmE6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tubl07IC8vIFRoZSByZW5kZXJlciB3aWxsIGhhbmRsZSB3aGVyZSB0byBwdXQgdGhpc1xyXG4gICAgICAgICAgICBjYXNlIFJlbGF0aXZlVG8ucGFyZW50OlxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMucGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVuaXQgPT09IFVuaXRzLnB4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmVudFtzZXR0aW5nXSArIHRoaXNbbm5dO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodW5pdCA9PT0gVW5pdHMucGMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50W29yaWVudGF0aW9uXSAqIHRoaXNbbm5dO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVuaXQgPT09IFVuaXRzLnB4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW25uXTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVuaXQgPT09IFVuaXRzLnBjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNjZW5lW29yaWVudGF0aW9uXSAqIHRoaXNbbm5dO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW25uXSBhcyBudW1iZXI7XHJcbiAgICAgICAgfSAgICAgICBcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldFhZV0goc2V0dGluZzogJ3gnIHwgJ3knIHwgJ3cnIHwgJ2gnLCB2YWx1ZTogbnVtYmVyLCB1bml0PzogVW5pdHMsIHJlbGF0aXZlVG8/OiBSZWxhdGl2ZVRvKSB7XHJcbiAgICAgICAgY29uc3Qgbm4gPSBzZXR0aW5nICsgc2V0dGluZzsgLy8gSGlkZGVuIHZhcmlhYmxlIG5hbWVzIGZvciB0aGVzZSBhcmUgYWx3YXlzIGRvdWJsZSB0aGUgY2hhcmFjdGVyXHJcbiAgICAgICAgdGhpc1tubl0gPSB2YWx1ZTtcclxuICAgICAgICBpZiAodW5pdCkge1xyXG4gICAgICAgICAgICB0aGlzW3NldHRpbmcgKyAnVW5pdCddID0gdW5pdDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHJlbGF0aXZlVG8pIHtcclxuICAgICAgICAgICAgdGhpc1tzZXR0aW5nICsgJ1JlbGF0aXZlVG8nXSA9IHJlbGF0aXZlVG87XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCB4KCk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0WFlXSCgneCcpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFgoeDogbnVtYmVyLCB1bml0PzogVW5pdHMsIHJlbGF0aXZlVG8/OiBSZWxhdGl2ZVRvKSB7XHJcbiAgICAgICAgdGhpcy5zZXRYWVdIKCd4JywgeCwgdW5pdCwgcmVsYXRpdmVUbyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IHkoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRYWVdIKCd5Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0WSh5OiBudW1iZXIsIHVuaXQ/OiBVbml0cywgcmVsYXRpdmVUbz86IFJlbGF0aXZlVG8pIHtcclxuICAgICAgICB0aGlzLnNldFhZV0goJ3knLCB5LCB1bml0LCByZWxhdGl2ZVRvKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgdygpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldFhZV0goJ3cnKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgdyh3OiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLnd3ID0gdztcclxuICAgIH1cclxuXHJcbiAgICBzZXRXKHc6IG51bWJlciwgdW5pdD86IFVuaXRzLCByZWxhdGl2ZVRvPzogUmVsYXRpdmVUbykge1xyXG4gICAgICAgIHRoaXMuc2V0WFlXSCgndycsIHcsIHVuaXQsIHJlbGF0aXZlVG8pOyAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGgoKTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXRYWVdIKCdoJyk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGgoaDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5oaCA9IGg7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0SChoOiBudW1iZXIsIHVuaXQ/OiBVbml0cywgcmVsYXRpdmVUbz86IFJlbGF0aXZlVG8pIHtcclxuICAgICAgICB0aGlzLnNldFhZV0goJ2gnLCBoLCB1bml0LCByZWxhdGl2ZVRvKTsgICAgICAgIFxyXG4gICAgfVxyXG5cclxuICAgIGFkZENoaWxkKGNoaWxkOiBSZW5kZXJOb2RlIHwgUmVuZGVyTm9kZUlEKSB7XHJcbiAgICAgICAgaWYgKGNoaWxkIGluc3RhbmNlb2YgUmVuZGVyTm9kZSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY2hpbGRyZW4uaW5jbHVkZXMoY2hpbGQuaWQpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQuaWQpO1xyXG4gICAgICAgICAgICAgICAgY2hpbGQucGFyZW50ID0gdGhpcztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoY2hpbGQgaW5zdGFuY2VvZiBSZW5kZXJOb2RlSUQpIHtcclxuICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gYWxsTm9kZXNbY2hpbGQubnVtYmVyXTtcclxuICAgICAgICAgICAgaWYgKGNoaWxkTm9kZSAmJiAhdGhpcy5jaGlsZHJlbi5pbmNsdWRlcyhjaGlsZCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7XHJcbiAgICAgICAgICAgICAgICBjaGlsZE5vZGUucGFyZW50ID0gdGhpcztcclxuICAgICAgICAgICAgfSBlbHNlIGlmICghY2hpbGROb2RlKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIFJlbmRlck5vZGUgZm91bmQgd2l0aCBpZCAke2NoaWxkLm51bWJlcn1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ2NoaWxkcmVuIG11c3QgYmUgc3VwcGxpZWQgYXMgUmVuZGVyTm9kZSBvciBSZW5kZXJOb2RlSUQnKTsgICAgICAgICAgICBcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlQ2hpbGQoY2hpbGQ6IFJlbmRlck5vZGUgfCBSZW5kZXJOb2RlSUQpIHtcclxuICAgICAgICBpZiAoIShjaGlsZCBpbnN0YW5jZW9mIFJlbmRlck5vZGUgfHwgY2hpbGQgaW5zdGFuY2VvZiBSZW5kZXJOb2RlSUQpKSB7IFxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdjaGlsZHJlbiBtdXN0IGJlIHN1cHBsaWVkIGFzIFJlbmRlck5vZGUgb3IgUmVuZGVyTm9kZUlEJyk7ICAgICBcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgY2hpbGRJZCA9IGNoaWxkIGluc3RhbmNlb2YgUmVuZGVyTm9kZUlEID8gY2hpbGQgOiBjaGlsZC5pZDtcclxuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZihjaGlsZElkKTtcclxuICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xyXG4gICAgICAgICAgICB0aGlzLmNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKiBMb29rcyByZWN1cnNpdmVseSB0byBwYXJlbnQgbm9kZXMgdG8gZXN0YWJsaXNoIHdoYXQgU2NlbmUgdGhpcyBSZW5kZXJOb2RlIGlzIGluICovXHJcbiAgICBnZXQgc2NlbmUoKTogTWF5YmU8U2NlbmU+IHtcclxuICAgICAgICBpZiAodGhpcy5wYXJlbnRJZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJlbnQ/LnNjZW5lO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwb3NzaWJsZVNjZW5lID0gU2NlbmUuYnlJZCh0aGlzLnNjZW5lSWQpO1xyXG4gICAgICAgIHJldHVybiBTY2VuZS5ieUlkKHRoaXMuc2NlbmVJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIFNob3VsZCBvbmx5IGJlIHNldCBvbiB0b3AtbGV2ZWwgUmVuZGVyTm9kZXMgKGF0dGFjaGVkIGRpcmVjdGx5IHRvIGEgU2NlbmUpLiBDaGlsZHJlbiBpbmhlcml0IGZyb20gdGhlIHBhcmVudC4gV2lsbCB0aHJvdyBlcnJvcnMgb3RoZXJ3aXNlICovXHJcbiAgICBzZXQgc2NlbmUoc2NlbmU6IE1heWJlPFNjZW5lPiB8IFNjZW5lSUQpIHtcclxuICAgICAgICBpZiAodGhpcy5wYXJlbnRJZCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoaXMgUmVuZGVyTm9kZSBoYXMgYSBwYXJlbnQgYW5kIHNob3VsZCBub3QgaGF2ZSBpdHMgU2NlbmUgY2hhbmdlZCBkaXJlY3RseS5gKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoc2NlbmUgaW5zdGFuY2VvZiBTY2VuZSkge1xyXG4gICAgICAgICAgICB0aGlzLnNjZW5lSWQgPSBzY2VuZS5pZDtcclxuICAgICAgICB9IGVsc2UgaWYgKHNjZW5lIGluc3RhbmNlb2YgU2NlbmVJRCkge1xyXG4gICAgICAgICAgICB0aGlzLnNjZW5lSWQgPSBzY2VuZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLnNjZW5lSWQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBoYXNDaGlsZHJlbigpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGggPiAwO1xyXG4gICAgfVxyXG5cclxuICAgIGZvckVhY2hDaGlsZChmbjogKGNoaWxkTm9kZTogUmVuZGVyTm9kZSkgPT4gdm9pZCkge1xyXG4gICAgICAgIHRoaXMuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGRJRCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwb3NzaWJsZUNoaWxkID0gUmVuZGVyTm9kZS5ieUlkKGNoaWxkSUQpO1xyXG4gICAgICAgICAgICBpZiAocG9zc2libGVDaGlsZCkge1xyXG4gICAgICAgICAgICAgICAgZm4ocG9zc2libGVDaGlsZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogUmVtb3ZlIGFsbCByZWZlcmVuY2VzIHRvIHRoaXMgUmVuZGVyTm9kZSBhbmQgYW55IG9mIGl0cyBjaGlsZHJlbiB3aGljaCB3b3VsZCBvdGhlcndpc2UgYmUgZmxvYXRpbmcgYXJvdW5kICovXHJcbiAgICBkZWxldGUoKSB7XHJcbiAgICAgICAgdGhpcy5mb3JFYWNoQ2hpbGQoKGNoaWxkKSA9PiBjaGlsZC5kZWxldGUoKSk7XHJcbiAgICAgICAgdGhpcy5wYXJlbnQ/LnJlbW92ZUNoaWxkKHRoaXMpO1xyXG4gICAgICAgIHRoaXMuc2NlbmU/LnJlbW92ZVJlbmRlck5vZGUodGhpcyk7XHJcbiAgICAgICAgZGVsZXRlIGFsbE5vZGVzW3RoaXMuaWQubnVtYmVyXTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgYnlJZChpZDogUmVuZGVyTm9kZUlEKTogUmVuZGVyTm9kZSB8IG51bGwge1xyXG4gICAgICAgIHJldHVybiBhbGxOb2Rlc1tpZC5udW1iZXJdO1xyXG4gICAgfVxyXG59Il19