"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Person = void 0;
const import_manager_js_1 = require("../../import-manager.js");
const typescript_helpers_js_1 = require("../../util/typescript-helpers.js");
const math_heleprs_js_1 = require("../../util/math-heleprs.js");
let firstUpdate = true;
class Person extends import_manager_js_1.Thing {
    constructor(data) {
        super(data);
        this._gridX = 0;
        this._gridY = 0;
        this.acceptingInput = false;
        this.firstName = data.firstName;
        this.surname = data.surname;
        this.jobTitle = data.jobTitle;
        this.imgFolder = data.imgFolder;
        this.renderNodes = {
            standing: this.makeDirectionalImage('standing'),
            walking: this.makeDirectionalAnimation('walking', 64, 64, 200, true),
            idle1: this.makeDirectionalAnimation('idle-1', 64, 64, 200, false)
        };
        this.currentRenderNodeId = this.renderNodes.standing.down.id;
        this.actionQueue = [];
        this.direction = 'down';
        this.nextFidgetTime = Infinity;
    }
    updateFidgetTime(frameTimeStamp) {
        this.nextFidgetTime = frameTimeStamp + ((0, math_heleprs_js_1.randomInt)(5, 15) * 500);
    }
    makeDirectionalImage(imageType) {
        const imgStart = `people/${this.imgFolder}/${imageType}`;
        return {
            up: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-u.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            down: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-d.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            left: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-l.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            right: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-r.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
        };
    }
    makeDirectionalAnimation(animationType, w, h, frameMillis, loops = true) {
        const imgStart = `people/${this.imgFolder}/${animationType}`;
        return {
            up: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-u.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            down: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-d.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            left: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-l.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            right: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-r.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
        };
    }
    get location() {
        return import_manager_js_1.Scene.byId(this.locationId);
    }
    get currentAction() {
        return this.actionQueue[0];
    }
    /** Moves this person to the Location specified, updation any current Location and the new Location objects as appropriate */
    goesTo(location, gridX, gridY) {
        var _a;
        const currentLocation = this.location;
        const newLocation = location instanceof import_manager_js_1.Location ? location : import_manager_js_1.Scene.byId(location);
        if (!newLocation) {
            throw new Error(`Invalid Location not provided - argument was ${location}`);
        }
        this.locationId = newLocation.id;
        currentLocation === null || currentLocation === void 0 ? void 0 : currentLocation.grid.removeThing(this);
        (_a = newLocation.grid.getSquare(gridX, gridY)) === null || _a === void 0 ? void 0 : _a.addThing(this);
        this.gridX = gridX;
        this.gridY = gridY;
        this.currentRenderNode = this.currentRenderNodeId;
        this.snapCurrentRenderNodeToGrid();
    }
    snapCurrentRenderNodeToGrid() {
        var _a, _b, _c, _d;
        this.currentRenderNode.setX(this.gridX * ((_b = (_a = this.location) === null || _a === void 0 ? void 0 : _a.gridSize) !== null && _b !== void 0 ? _b : 1));
        this.currentRenderNode.setY(this.gridY * ((_d = (_c = this.location) === null || _c === void 0 ? void 0 : _c.gridSize) !== null && _d !== void 0 ? _d : 1));
        this.updateGridRenderSlot();
    }
    /** Calling this removes this Person from their current grid-based RenderNode (if they have one), and inserts them into a new one based on location and gridY */
    updateGridRenderSlot() {
        var _a;
        (_a = this.location) === null || _a === void 0 ? void 0 : _a.addRenderNodeAtY(this.currentRenderNode, this.gridY);
    }
    /** Adds a Wait action to this Person's queue */
    waits(millis) {
        this.addAction(new import_manager_js_1.Wait(this, millis));
    }
    set gridY(y) {
        this._gridY = y;
        this.updateGridRenderSlot();
        this.snapCurrentRenderNodeToGrid();
    }
    get gridY() {
        return this._gridY;
    }
    set gridX(x) {
        this._gridX = x;
        this.snapCurrentRenderNodeToGrid();
    }
    get gridX() {
        return this._gridX;
    }
    handleInput(input) {
        if (this.acceptingInput && (!this.currentAction || this.currentAction.complete)) {
            if (input.up.held) {
                this.direction = "up";
                if (this.canWalkUp) {
                    this.walksUp();
                }
            }
            else if (input.down.held) {
                this.direction = 'down';
                if (this.canWalkDown) {
                    this.walksDown();
                }
            }
            else if (input.left.held) {
                this.direction = 'left';
                if (this.canWalkLeft) {
                    this.walksLeft();
                }
            }
            else if (input.right.held) {
                this.direction = 'right';
                if (this.canWalkRight) {
                    this.walksRight();
                }
            }
        }
    }
    /** Queue up an action */
    addAction(action) {
        this.actionQueue.push(action);
    }
    /** Queue up a list of actions (they will be in the order provided) */
    addActions(actions) {
        this.actionQueue.concat(actions);
    }
    walks(direction, squares = 1) {
        var _a;
        this.direction = direction;
        for (let i = 0; i < squares; i += 1) {
            if (this.followedBy) {
                if (this.isIdle && this.followedBy.isIdle) {
                    this.followedBy.waits(100);
                }
                (_a = this.followedBy) === null || _a === void 0 ? void 0 : _a.walksTowards(this._gridX, this._gridY);
            }
            this.addAction(new import_manager_js_1.Walk(this, direction));
        }
    }
    /** Check if this Person's action queue is empty */
    get isIdle() {
        return this.actionQueue.length === 0;
    }
    walksUp(squares = 1) {
        this.walks('up', squares);
        return this;
    }
    walksDown(squares = 1) {
        this.walks('down', squares);
        return this;
    }
    walksLeft(squares = 1) {
        this.walks('left', squares);
        return this;
    }
    walksRight(squares = 1) {
        this.walks('right', squares);
        return this;
    }
    walksTowards(x, y) {
        const xDiff = this.gridX - x;
        const yDiff = this.gridY - y;
        if (Math.abs(xDiff) > Math.abs(yDiff)) {
            if (xDiff < 0 && this.canWalkRight) {
                this.walksRight();
                return;
            }
            if (xDiff > 0 && this.canWalkLeft) {
                this.walksLeft();
                return;
            }
        }
        if (yDiff < 0 && this.canWalkDown) {
            this.walksDown();
            return;
        }
        if (yDiff > 0 && this.canWalkUp) {
            this.walksUp();
        }
    }
    canWalkTo(x, y) {
        var _a, _b, _c;
        return (_c = (_b = (_a = this.location) === null || _a === void 0 ? void 0 : _a.grid.getSquare(x, y)) === null || _b === void 0 ? void 0 : _b.walkable) !== null && _c !== void 0 ? _c : false;
    }
    get canWalkUp() {
        return this.canWalkTo(this.gridX, this.gridY - 1);
    }
    get canWalkDown() {
        return this.canWalkTo(this.gridX, this.gridY + 1);
    }
    get canWalkLeft() {
        return this.canWalkTo(this.gridX - 1, this.gridY);
    }
    get canWalkRight() {
        return this.canWalkTo(this.gridX + 1, this.gridY);
    }
    update(frameTimeStamp) {
        if (firstUpdate) {
            this.updateFidgetTime(frameTimeStamp);
        }
        if (this.currentAction) {
            if (!this.currentAction.inProgress && !this.currentAction.complete) {
                this.currentAction.start();
            }
            if (this.currentAction.complete) {
                this.actionQueue.shift();
                if (this.actionQueue.length === 0) { // Going idle...
                    this.updateFidgetTime(frameTimeStamp);
                    this.currentRenderNode = this.renderNodes.standing[this.direction];
                }
                this.update(frameTimeStamp);
            }
            else {
                this.currentAction.update(frameTimeStamp);
            }
        }
        else { // Idle
            if (frameTimeStamp > this.nextFidgetTime) {
                const fidgetNode = this.renderNodes.idle1[this.direction];
                fidgetNode.reset();
                this.currentRenderNode = fidgetNode;
                this.updateFidgetTime(frameTimeStamp);
            }
            this.snapCurrentRenderNodeToGrid();
        }
        firstUpdate = false;
    }
    /** The current RenderNode always gets put in the Location of this Person */
    set currentRenderNode(node) {
        var _a;
        if (this.currentRenderNodeId) {
            this.currentRenderNode.detach();
        }
        if (node instanceof import_manager_js_1.RenderNode) {
            this.currentRenderNodeId = node.id;
        }
        else {
            this.currentRenderNodeId = node;
        }
        (_a = this.location) === null || _a === void 0 ? void 0 : _a.addRenderNodeAtY(this.currentRenderNode, this.gridY);
    }
    get currentRenderNode() {
        return (0, typescript_helpers_js_1.definitely)(import_manager_js_1.RenderNode.byId(this.currentRenderNodeId));
    }
    // Tell this person to keep walking after another person
    follows(otherPerson) {
        this.following = otherPerson;
        otherPerson.followedBy = this;
    }
    stopsFollowing() {
        var _a;
        if ((_a = this.following) === null || _a === void 0 ? void 0 : _a.followedBy) {
            this.following.followedBy = undefined;
        }
        this.following = undefined;
    }
    /** Is this person one square up, down, left or right of the other person */
    isNextTo(otherPerson) {
        if (this.location !== otherPerson.location) {
            return false;
        }
        const xDiff = Math.abs(this.gridX - otherPerson.gridX);
        if (xDiff > 1) {
            return false;
        }
        const yDiff = Math.abs(this.gridY - otherPerson.gridY);
        if (yDiff > 1) {
            return false;
        }
        if (xDiff === 1 && yDiff === 1) {
            return false;
        }
        return true;
    }
}
exports.Person = Person;
Person.spriteOffsetX = -24;
Person.spriteOffsetY = -38;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGVyc29uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdGhpbmdzL3Blb3BsZS9QZXJzb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0RBQXVMO0FBQ3ZMLDRFQUFxRTtBQUNyRSxnRUFBdUQ7QUFHdkQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO0FBc0J2QixNQUFhLE1BQU8sU0FBUSx5QkFBSztJQW1CN0IsWUFBWSxJQUFnQjtRQUN4QixLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFaUixXQUFNLEdBQVcsQ0FBQyxDQUFDO1FBQ25CLFdBQU0sR0FBVyxDQUFDLENBQUM7UUFFM0IsbUJBQWMsR0FBWSxLQUFLLENBQUM7UUFVNUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUM1QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7UUFDOUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxXQUFXLEdBQUc7WUFDZixRQUFRLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQztZQUMvQyxPQUFPLEVBQUUsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFNBQVMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUM7WUFDcEUsS0FBSyxFQUFFLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxRQUFRLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDO1NBQ3JFLENBQUE7UUFDRCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FB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V0FBVyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7SUFDbEMsQ0FBQztJQUVELGNBQWM7O1FBQ1YsSUFBSSxNQUFBLElBQUksQ0FBQyxTQUFTLDBDQUFFLFVBQVUsRUFBRTtZQUM1QixJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7U0FDekM7UUFDRCxJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztJQUMvQixDQUFDO0lBRUQsNEVBQTRFO0lBQzVFLFFBQVEsQ0FBQyxXQUFtQjtRQUN4QixJQUFJLElBQUksQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLFFBQVEsRUFBRTtZQUN4QyxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkQsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFO1lBQ1gsT0FBTyxLQUFLLENBQUM7U0FDaEI7UUFDRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZELElBQUksS0FBSyxHQUFHLENBQUMsRUFBRTtZQUNYLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsSUFBSSxLQUFLLEtBQUssQ0FBQyxJQUFJLEtBQUssS0FBSyxDQUFDLEVBQUU7WUFDNUIsT0FBTyxLQUFLLENBQUM7U0FDaEI7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOztBQS9UTCx3QkFnVUM7QUFuVGtCLG9CQUFhLEdBQVcsQ0FBQyxFQUFFLENBQUM7QUFDNUIsb0JBQWEsR0FBVyxDQUFDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRoaW5nLCBUaGluZ0RhdGEsIEFuaW1hdGlvbk5vZGUsIEltYWdlTm9kZSwgU2NlbmVJRCwgTG9jYXRpb24sIFNjZW5lLCBJbnB1dERhdGEsIFJlbmRlck5vZGVJRCwgUmVuZGVyTm9kZSwgQWN0aW9uLCBXYWxrLCBXYWxrRGlyZWN0aW9uLCBXYWl0IH0gZnJvbSAnLi4vLi4vaW1wb3J0LW1hbmFnZXIuanMnO1xyXG5pbXBvcnQgeyBNYXliZSwgZGVmaW5pdGVseSB9IGZyb20gJy4uLy4uL3V0aWwvdHlwZXNjcmlwdC1oZWxwZXJzLmpzJztcclxuaW1wb3J0IHsgcmFuZG9tSW50IH0gZnJvbSAnLi4vLi4vdXRpbC9tYXRoLWhlbGVwcnMuanMnO1xyXG5cclxuZXhwb3J0IHR5cGUgRGlyZWN0aW9uID0gJ3VwJyB8ICdkb3duJyB8ICdsZWZ0JyB8ICdyaWdodCc7XHJcbmxldCBmaXJzdFVwZGF0ZSA9IHRydWU7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERpcmVjdGlvbmFsPFQ+IHtcclxuICAgIHVwOiBULFxyXG4gICAgZG93bjogVCxcclxuICAgIGxlZnQ6IFQsXHJcbiAgICByaWdodDogVCxcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQZXJzb25SZW5kZXJOb2RlcyB7XHJcbiAgICBzdGFuZGluZzogRGlyZWN0aW9uYWw8SW1hZ2VOb2RlPixcclxuICAgIHdhbGtpbmc6IERpcmVjdGlvbmFsPEFuaW1hdGlvbk5vZGU+LFxyXG4gICAgaWRsZTE6IERpcmVjdGlvbmFsPEFuaW1hdGlvbk5vZGU+LFxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBQZXJzb25EYXRhID0gVGhpbmdEYXRhICYge1xyXG4gICAgZmlyc3ROYW1lOiBzdHJpbmcsXHJcbiAgICBzdXJuYW1lOiBzdHJpbmcsXHJcbiAgICBqb2JUaXRsZTogc3RyaW5nLFxyXG4gICAgaW1nRm9sZGVyOiBzdHJpbmcsXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBQZXJzb24gZXh0ZW5kcyBUaGluZyB7XHJcbiAgICBmaXJzdE5hbWU6IHN0cmluZztcclxuICAgIHN1cm5hbWU6IHN0cmluZztcclxuICAgIGpvYlRpdGxlOiBzdHJpbmc7XHJcbiAgICBpbWdGb2xkZXI6IHN0cmluZztcclxuICAgIHJlbmRlck5vZGVzOiBQZXJzb25SZW5kZXJOb2RlcztcclxuICAgIGRpcmVjdGlvbjogRGlyZWN0aW9uO1xyXG4gICAgcHJpdmF0ZSBjdXJyZW50UmVuZGVyTm9kZUlkOiBSZW5kZXJOb2RlSUQ7XHJcbiAgICBwcml2YXRlIF9ncmlkWDogbnVtYmVyID0gMDtcclxuICAgIHByaXZhdGUgX2dyaWRZOiBudW1iZXIgPSAwO1xyXG4gICAgcHJpdmF0ZSBsb2NhdGlvbklkOiBNYXliZTxTY2VuZUlEPjtcclxuICAgIGFjY2VwdGluZ0lucHV0OiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIGFjdGlvblF1ZXVlOiBBY3Rpb25bXTtcclxuICAgIHByaXZhdGUgc3RhdGljIHNwcml0ZU9mZnNldFg6IG51bWJlciA9IC0yNDtcclxuICAgIHByaXZhdGUgc3RhdGljIHNwcml0ZU9mZnNldFk6IG51bWJlciA9IC0zODtcclxuICAgIGZvbGxvd2luZzogTWF5YmU8UGVyc29uPlxyXG4gICAgZm9sbG93ZWRCeTogTWF5YmU8UGVyc29uPlxyXG4gICAgcHJpdmF0ZSBuZXh0RmlkZ2V0VGltZTogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGRhdGE6IFBlcnNvbkRhdGEpIHtcclxuICAgICAgICBzdXBlcihkYXRhKTtcclxuICAgICAgICB0aGlzLmZpcnN0TmFtZSA9IGRhdGEuZmlyc3ROYW1lO1xyXG4gICAgICAgIHRoaXMuc3VybmFtZSA9IGRhdGEuc3VybmFtZTtcclxuICAgICAgICB0aGlzLmpvYlRpdGxlID0gZGF0YS5qb2JUaXRsZTtcclxuICAgICAgICB0aGlzLmltZ0ZvbGRlciA9IGRhdGEuaW1nRm9sZGVyO1xyXG4gICAgICAgIHRoaXMucmVuZGVyTm9kZXMgPSB7XHJcbiAgICAgICAgICAgIHN0YW5kaW5nOiB0aGlzLm1ha2VEaXJlY3Rpb25hbEltYWdlKCdzdGFuZGluZycpLFxyXG4gICAgICAgICAgICB3YWxraW5nOiB0aGlzLm1ha2VEaXJlY3Rpb25hbEFuaW1hdGlvbignd2Fsa2luZycsIDY0LCA2NCwgMjAwLCB0cnVlKSxcclxuICAgICAgICAgICAgaWRsZTE6IHRoaXMubWFrZURpcmVjdGlvbmFsQW5pbWF0aW9uKCdpZGxlLTEnLCA2NCwgNjQsIDIwMCwgZmFsc2UpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuY3VycmVudFJlbmRlck5vZGVJZCA9IHRoaXMucmVuZGVyTm9kZXMuc3RhbmRpbmcuZG93bi5pZDtcclxuICAgICAgICB0aGlzLmFjdGlvblF1ZXVlID0gW107XHJcbiAgICAgICAgdGhpcy5kaXJlY3Rpb24gPSAnZG93bic7XHJcbiAgICAgICAgdGhpcy5uZXh0RmlkZ2V0VGltZSA9IEluZmluaXR5O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlRmlkZ2V0VGltZShmcmFtZVRpbWVTdGFtcDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5uZXh0RmlkZ2V0VGltZSA9IGZyYW1lVGltZVN0YW1wICsgKHJhbmRvbUludCg1LCAxNSkgKiA1MDApO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbWFrZURpcmVjdGlvbmFsSW1hZ2UoaW1hZ2VUeXBlOiBzdHJpbmcpOiBEaXJlY3Rpb25hbDxJbWFnZU5vZGU+IHtcclxuICAgICAgICBjb25zdCBpbWdTdGFydCA9IGBwZW9wbGUvJHt0aGlzLmltZ0ZvbGRlcn0vJHtpbWFnZVR5cGV9YDtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB1cDogbmV3IEltYWdlTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tdS5wbmdgLCBvZmZzZXRYOiBQZXJzb24uc3ByaXRlT2Zmc2V0WCwgb2Zmc2V0WTogUGVyc29uLnNwcml0ZU9mZnNldFl9KSxcclxuICAgICAgICAgICAgZG93bjogbmV3IEltYWdlTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tZC5wbmdgLCBvZmZzZXRYOiBQZXJzb24uc3ByaXRlT2Zmc2V0WCwgb2Zmc2V0WTogUGVyc29uLnNwcml0ZU9mZnNldFl9KSxcclxuICAgICAgICAgICAgbGVmdDogbmV3IEltYWdlTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tbC5wbmdgLCBvZmZzZXRYOiBQZXJzb24uc3ByaXRlT2Zmc2V0WCwgb2Zmc2V0WTogUGVyc29uLnNwcml0ZU9mZnNldFl9KSwgICAgICAgICAgICBcclxuICAgICAgICAgICAgcmlnaHQ6IG5ldyBJbWFnZU5vZGUoe2ltYWdlTmFtZTogYCR7aW1nU3RhcnR9LXIucG5nYCwgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksICAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbWFrZURpcmVjdGlvbmFsQW5pbWF0aW9uKGFuaW1hdGlvblR5cGU6IHN0cmluZywgdzogbnVtYmVyLCBoOiBudW1iZXIsIGZyYW1lTWlsbGlzOiBudW1iZXIsIGxvb3BzOiBib29sZWFuID0gdHJ1ZSk6IERpcmVjdGlvbmFsPEFuaW1hdGlvbk5vZGU+IHtcclxuICAgICAgICBjb25zdCBpbWdTdGFydCA9IGBwZW9wbGUvJHt0aGlzLmltZ0ZvbGRlcn0vJHthbmltYXRpb25UeXBlfWA7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdXA6IG5ldyBBbmltYXRpb25Ob2RlKHtpbWFnZU5hbWU6IGAke2ltZ1N0YXJ0fS11LnBuZ2AsIHcsIGgsIGZyYW1lTWlsbGlzLCBsb29wcywgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksXHJcbiAgICAgICAgICAgIGRvd246IG5ldyBBbmltYXRpb25Ob2RlKHtpbWFnZU5hbWU6IGAke2ltZ1N0YXJ0fS1kLnBuZ2AsIHcsIGgsIGZyYW1lTWlsbGlzLCBsb29wcywgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxlZnQ6IG5ldyBBbmltYXRpb25Ob2RlKHtpbWFnZU5hbWU6IGAke2ltZ1N0YXJ0fS1sLnBuZ2AsIHcsIGgsIGZyYW1lTWlsbGlzLCBsb29wcywgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksXHJcbiAgICAgICAgICAgIHJpZ2h0OiBuZXcgQW5pbWF0aW9uTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tci5wbmdgLCB3LCBoLCBmcmFtZU1pbGxpcywgbG9vcHMsIG9mZnNldFg6IFBlcnNvbi5zcHJpdGVPZmZzZXRYLCBvZmZzZXRZOiBQZXJzb24uc3ByaXRlT2Zmc2V0WX0pLFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgbG9jYXRpb24oKTogTWF5YmU8TG9jYXRpb24+IHtcclxuICAgICAgICByZXR1cm4gU2NlbmUuYnlJZCh0aGlzLmxvY2F0aW9uSWQpIGFzIE1heWJlPExvY2F0aW9uPjtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY3VycmVudEFjdGlvbigpOiBNYXliZTxBY3Rpb24+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25RdWV1ZVswXTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogTW92ZXMgdGhpcyBwZXJzb24gdG8gdGhlIExvY2F0aW9uIHNwZWNpZmllZCwgdXBkYXRpb24gYW55IGN1cnJlbnQgTG9jYXRpb24gYW5kIHRoZSBuZXcgTG9jYXRpb24gb2JqZWN0cyBhcyBhcHByb3ByaWF0ZSAqL1xyXG4gICAgZ29lc1RvKGxvY2F0aW9uOiBMb2NhdGlvbiB8IFNjZW5lSUQsIGdyaWRYOiBudW1iZXIsIGdyaWRZOiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBjdXJyZW50TG9jYXRpb24gPSB0aGlzLmxvY2F0aW9uO1xyXG4gICAgICAgIGNvbnN0IG5ld0xvY2F0aW9uID0gbG9jYXRpb24gaW5zdGFuY2VvZiBMb2NhdGlvbiA/IGxvY2F0aW9uIDogU2NlbmUuYnlJZChsb2NhdGlvbikgYXMgTG9jYXRpb247XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCFuZXdMb2NhdGlvbikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgTG9jYXRpb24gbm90IHByb3ZpZGVkIC0gYXJndW1lbnQgd2FzICR7bG9jYXRpb259YCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmxvY2F0aW9uSWQgPSBuZXdMb2NhdGlvbi5pZDtcclxuXHJcbiAgICAgICAgY3VycmVudExvY2F0aW9uPy5ncmlkLnJlbW92ZVRoaW5nKHRoaXMpO1xyXG5cclxuICAgICAgICBuZXdMb2NhdGlvbi5ncmlkLmdldFNxdWFyZShncmlkWCwgZ3JpZFkpPy5hZGRUaGluZyh0aGlzKTtcclxuXHJcbiAgICAgICAgdGhpcy5ncmlkWCA9IGdyaWRYO1xyXG4gICAgICAgIHRoaXMuZ3JpZFkgPSBncmlkWTtcclxuXHJcbiAgICAgICAgdGhpcy5jdXJyZW50UmVuZGVyTm9kZSA9IHRoaXMuY3VycmVudFJlbmRlck5vZGVJZDtcclxuICAgICAgICB0aGlzLnNuYXBDdXJyZW50UmVuZGVyTm9kZVRvR3JpZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHNuYXBDdXJyZW50UmVuZGVyTm9kZVRvR3JpZCgpIHtcclxuICAgICAgICB0aGlzLmN1cnJlbnRSZW5kZXJOb2RlLnNldFgodGhpcy5ncmlkWCAqICh0aGlzLmxvY2F0aW9uPy5ncmlkU2l6ZSA/PyAxKSk7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50UmVuZGVyTm9kZS5zZXRZKHRoaXMuZ3JpZFkgKiAodGhpcy5sb2NhdGlvbj8uZ3JpZFNpemUgPz8gMSkpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlR3JpZFJlbmRlclNsb3QoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogQ2FsbGluZyB0aGlzIHJlbW92ZXMgdGhpcyBQZXJzb24gZnJvbSB0aGVpciBjdXJyZW50IGdyaWQtYmFzZWQgUmVuZGVyTm9kZSAoaWYgdGhleSBoYXZlIG9uZSksIGFuZCBpbnNlcnRzIHRoZW0gaW50byBhIG5ldyBvbmUgYmFzZWQgb24gbG9jYXRpb24gYW5kIGdyaWRZICovXHJcbiAgICB1cGRhdGVHcmlkUmVuZGVyU2xvdCgpIHtcclxuICAgICAgICB0aGlzLmxvY2F0aW9uPy5hZGRSZW5kZXJOb2RlQXRZKHRoaXMuY3VycmVudFJlbmRlck5vZGUsIHRoaXMuZ3JpZFkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiBBZGRzIGEgV2FpdCBhY3Rpb24gdG8gdGhpcyBQZXJzb24ncyBxdWV1ZSAqL1xyXG4gICAgd2FpdHMobWlsbGlzOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLmFkZEFjdGlvbihuZXcgV2FpdCh0aGlzLCBtaWxsaXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXQgZ3JpZFkoeTogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5fZ3JpZFkgPSB5O1xyXG4gICAgICAgIHRoaXMudXBkYXRlR3JpZFJlbmRlclNsb3QoKTtcclxuICAgICAgICB0aGlzLnNuYXBDdXJyZW50UmVuZGVyTm9kZVRvR3JpZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBncmlkWSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZ3JpZFk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0IGdyaWRYKHg6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuX2dyaWRYID0geDtcclxuICAgICAgICB0aGlzLnNuYXBDdXJyZW50UmVuZGVyTm9kZVRvR3JpZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBncmlkWCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZ3JpZFg7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgaGFuZGxlSW5wdXQoaW5wdXQ6IElucHV0RGF0YSkge1xyXG4gICAgICAgIGlmICh0aGlzLmFjY2VwdGluZ0lucHV0ICYmICghdGhpcy5jdXJyZW50QWN0aW9uIHx8IHRoaXMuY3VycmVudEFjdGlvbi5jb21wbGV0ZSkpIHtcclxuICAgICAgICAgICAgaWYgKGlucHV0LnVwLmhlbGQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID0gXCJ1cFwiO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FuV2Fsa1VwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53YWxrc1VwKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5wdXQuZG93bi5oZWxkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpcmVjdGlvbiA9ICdkb3duJztcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbldhbGtEb3duKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53YWxrc0Rvd24oKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIGlmIChpbnB1dC5sZWZ0LmhlbGQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID0gJ2xlZnQnO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuY2FuV2Fsa0xlZnQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLndhbGtzTGVmdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlucHV0LnJpZ2h0LmhlbGQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID0gJ3JpZ2h0JztcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbldhbGtSaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMud2Fsa3NSaWdodCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKiBRdWV1ZSB1cCBhbiBhY3Rpb24gKi9cclxuICAgIGFkZEFjdGlvbihhY3Rpb246IEFjdGlvbikge1xyXG4gICAgICAgIHRoaXMuYWN0aW9uUXVldWUucHVzaChhY3Rpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiBRdWV1ZSB1cCBhIGxpc3Qgb2YgYWN0aW9ucyAodGhleSB3aWxsIGJlIGluIHRoZSBvcmRlciBwcm92aWRlZCkgKi9cclxuICAgIGFkZEFjdGlvbnMoYWN0aW9uczogQWN0aW9uW10pIHtcclxuICAgICAgICB0aGlzLmFjdGlvblF1ZXVlLmNvbmNhdChhY3Rpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHdhbGtzKGRpcmVjdGlvbjogV2Fsa0RpcmVjdGlvbiwgc3F1YXJlczogbnVtYmVyID0gMSkge1xyXG4gICAgICAgIHRoaXMuZGlyZWN0aW9uID0gZGlyZWN0aW9uO1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3F1YXJlczsgaSArPSAxKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmZvbGxvd2VkQnkpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzSWRsZSAmJiB0aGlzLmZvbGxvd2VkQnkuaXNJZGxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb2xsb3dlZEJ5LndhaXRzKDEwMCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmZvbGxvd2VkQnk/LndhbGtzVG93YXJkcyh0aGlzLl9ncmlkWCwgdGhpcy5fZ3JpZFkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuYWRkQWN0aW9uKG5ldyBXYWxrKHRoaXMsIGRpcmVjdGlvbikpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogQ2hlY2sgaWYgdGhpcyBQZXJzb24ncyBhY3Rpb24gcXVldWUgaXMgZW1wdHkgKi9cclxuICAgIGdldCBpc0lkbGUoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuYWN0aW9uUXVldWUubGVuZ3RoID09PSAwO1xyXG4gICAgfVxyXG5cclxuICAgIHdhbGtzVXAoc3F1YXJlczogbnVtYmVyID0gMSk6IFBlcnNvbiB7XHJcbiAgICAgICAgdGhpcy53YWxrcygndXAnLCBzcXVhcmVzKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICB3YWxrc0Rvd24oc3F1YXJlczogbnVtYmVyID0gMSk6IFBlcnNvbiB7XHJcbiAgICAgICAgdGhpcy53YWxrcygnZG93bicsIHNxdWFyZXMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIHdhbGtzTGVmdChzcXVhcmVzOiBudW1iZXIgPSAxKTogUGVyc29uIHtcclxuICAgICAgICB0aGlzLndhbGtzKCdsZWZ0Jywgc3F1YXJlcyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgd2Fsa3NSaWdodChzcXVhcmVzOiBudW1iZXIgPSAxKTogUGVyc29uIHtcclxuICAgICAgICB0aGlzLndhbGtzKCdyaWdodCcsIHNxdWFyZXMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIHdhbGtzVG93YXJkcyh4OiBudW1iZXIsIHk6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IHhEaWZmID0gdGhpcy5ncmlkWCAtIHg7XHJcbiAgICAgICAgY29uc3QgeURpZmYgPSB0aGlzLmdyaWRZIC0geTtcclxuICAgICAgICBpZiAoTWF0aC5hYnMoeERpZmYpID4gTWF0aC5hYnMoeURpZmYpKSB7XHJcbiAgICAgICAgICAgIGlmICh4RGlmZiA8IDAgJiYgdGhpcy5jYW5XYWxrUmlnaHQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMud2Fsa3NSaWdodCgpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh4RGlmZiA+IDAgJiYgdGhpcy5jYW5XYWxrTGVmdCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy53YWxrc0xlZnQoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoeURpZmYgPCAwICYmIHRoaXMuY2FuV2Fsa0Rvd24pIHtcclxuICAgICAgICAgICAgdGhpcy53YWxrc0Rvd24oKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoeURpZmYgPiAwICYmIHRoaXMuY2FuV2Fsa1VwKSB7XHJcbiAgICAgICAgICAgIHRoaXMud2Fsa3NVcCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhbldhbGtUbyh4OiBudW1iZXIsIHk6IG51bWJlcikge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uPy5ncmlkLmdldFNxdWFyZSh4LCB5KT8ud2Fsa2FibGUgPz8gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGNhbldhbGtVcCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jYW5XYWxrVG8odGhpcy5ncmlkWCwgdGhpcy5ncmlkWSAtIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBjYW5XYWxrRG93bigpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jYW5XYWxrVG8odGhpcy5ncmlkWCwgdGhpcy5ncmlkWSArIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBjYW5XYWxrTGVmdCgpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jYW5XYWxrVG8odGhpcy5ncmlkWCAtIDEsIHRoaXMuZ3JpZFkpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBjYW5XYWxrUmlnaHQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuV2Fsa1RvKHRoaXMuZ3JpZFggKyAxLCB0aGlzLmdyaWRZKTtcclxuICAgIH1cclxuXHJcbiAgICBvdmVycmlkZSB1cGRhdGUoZnJhbWVUaW1lU3RhbXA6IG51bWJlcikge1xyXG4gICAgICAgIGlmIChmaXJzdFVwZGF0ZSkge1xyXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUZpZGdldFRpbWUoZnJhbWVUaW1lU3RhbXApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50QWN0aW9uKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jdXJyZW50QWN0aW9uLmluUHJvZ3Jlc3MgJiYgIXRoaXMuY3VycmVudEFjdGlvbi5jb21wbGV0ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QWN0aW9uLnN0YXJ0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEFjdGlvbi5jb21wbGV0ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25RdWV1ZS5zaGlmdCgpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYWN0aW9uUXVldWUubGVuZ3RoID09PSAwKSB7IC8vIEdvaW5nIGlkbGUuLi5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUZpZGdldFRpbWUoZnJhbWVUaW1lU3RhbXApO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFJlbmRlck5vZGUgPSB0aGlzLnJlbmRlck5vZGVzLnN0YW5kaW5nW3RoaXMuZGlyZWN0aW9uXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKGZyYW1lVGltZVN0YW1wKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEFjdGlvbi51cGRhdGUoZnJhbWVUaW1lU3RhbXApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHsgLy8gSWRsZVxyXG4gICAgICAgICAgICBpZiAoZnJhbWVUaW1lU3RhbXAgPiB0aGlzLm5leHRGaWRnZXRUaW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBmaWRnZXROb2RlID0gdGhpcy5yZW5kZXJOb2Rlcy5pZGxlMVt0aGlzLmRpcmVjdGlvbl07XHJcbiAgICAgICAgICAgICAgICBmaWRnZXROb2RlLnJlc2V0KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRSZW5kZXJOb2RlID0gZmlkZ2V0Tm9kZTtcclxuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlRmlkZ2V0VGltZShmcmFtZVRpbWVTdGFtcCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5zbmFwQ3VycmVudFJlbmRlck5vZGVUb0dyaWQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGZpcnN0VXBkYXRlID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIFRoZSBjdXJyZW50IFJlbmRlck5vZGUgYWx3YXlzIGdldHMgcHV0IGluIHRoZSBMb2NhdGlvbiBvZiB0aGlzIFBlcnNvbiAqL1xyXG4gICAgc2V0IGN1cnJlbnRSZW5kZXJOb2RlKG5vZGU6IFJlbmRlck5vZGUgfCBSZW5kZXJOb2RlSUQpIHtcclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50UmVuZGVyTm9kZUlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFJlbmRlck5vZGUuZGV0YWNoKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChub2RlIGluc3RhbmNlb2YgUmVuZGVyTm9kZSkge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRSZW5kZXJOb2RlSWQgPSBub2RlLmlkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFJlbmRlck5vZGVJZCA9IG5vZGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubG9jYXRpb24/LmFkZFJlbmRlck5vZGVBdFkodGhpcy5jdXJyZW50UmVuZGVyTm9kZSwgdGhpcy5ncmlkWSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGN1cnJlbnRSZW5kZXJOb2RlKCk6IFJlbmRlck5vZGUge1xyXG4gICAgICAgIHJldHVybiBkZWZpbml0ZWx5KFJlbmRlck5vZGUuYnlJZCh0aGlzLmN1cnJlbnRSZW5kZXJOb2RlSWQpKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBUZWxsIHRoaXMgcGVyc29uIHRvIGtlZXAgd2Fsa2luZyBhZnRlciBhbm90aGVyIHBlcnNvblxyXG4gICAgZm9sbG93cyhvdGhlclBlcnNvbjogUGVyc29uKSB7XHJcbiAgICAgICAgdGhpcy5mb2xsb3dpbmcgPSBvdGhlclBlcnNvbjtcclxuICAgICAgICBvdGhlclBlcnNvbi5mb2xsb3dlZEJ5ID0gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBzdG9wc0ZvbGxvd2luZygpIHtcclxuICAgICAgICBpZiAodGhpcy5mb2xsb3dpbmc/LmZvbGxvd2VkQnkpIHtcclxuICAgICAgICAgICAgdGhpcy5mb2xsb3dpbmcuZm9sbG93ZWRCeSA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5mb2xsb3dpbmcgPSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIElzIHRoaXMgcGVyc29uIG9uZSBzcXVhcmUgdXAsIGRvd24sIGxlZnQgb3IgcmlnaHQgb2YgdGhlIG90aGVyIHBlcnNvbiAqL1xyXG4gICAgaXNOZXh0VG8ob3RoZXJQZXJzb246IFBlcnNvbik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh0aGlzLmxvY2F0aW9uICE9PSBvdGhlclBlcnNvbi5sb2NhdGlvbikge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHhEaWZmID0gTWF0aC5hYnModGhpcy5ncmlkWCAtIG90aGVyUGVyc29uLmdyaWRYKTtcclxuICAgICAgICBpZiAoeERpZmYgPiAxKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgeURpZmYgPSBNYXRoLmFicyh0aGlzLmdyaWRZIC0gb3RoZXJQZXJzb24uZ3JpZFkpO1xyXG4gICAgICAgIGlmICh5RGlmZiA+IDEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoeERpZmYgPT09IDEgJiYgeURpZmYgPT09IDEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxufSJdfQ==