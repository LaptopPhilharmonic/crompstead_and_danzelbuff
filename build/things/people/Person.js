"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Person = void 0;
const import_manager_js_1 = require("../../import-manager.js");
const typescript_helpers_js_1 = require("../../util/typescript-helpers.js");
class Person extends import_manager_js_1.Thing {
    constructor(data) {
        super(data);
        this.gridX = 0;
        this.gridY = 0;
        this.acceptingInput = false;
        this.firstName = data.firstName;
        this.surname = data.surname;
        this.jobTitle = data.jobTitle;
        this.imgFolder = data.imgFolder;
        this.renderNodes = {
            standing: this.makeDirectionalImage('standing'),
            walking: this.makeDirectionalAnimation('walking', 64, 64, 200, true)
        };
        this.currentRenderNodeId = this.renderNodes.standing.down.id;
        this.actionQueue = [];
        this.direction = 'down';
    }
    makeDirectionalImage(imageType) {
        const imgStart = `people/${this.imgFolder}/${imageType}`;
        return {
            up: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-u.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            down: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-d.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            left: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-l.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            right: new import_manager_js_1.ImageNode({ imageName: `${imgStart}-r.png`, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
        };
    }
    makeDirectionalAnimation(animationType, w, h, frameMillis, loops = true) {
        const imgStart = `people/${this.imgFolder}/${animationType}`;
        return {
            up: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-u.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            down: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-d.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            left: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-l.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
            right: new import_manager_js_1.AnimationNode({ imageName: `${imgStart}-r.png`, w, h, frameMillis, loops, offsetX: Person.spriteOffsetX, offsetY: Person.spriteOffsetY }),
        };
    }
    get location() {
        return import_manager_js_1.Scene.byId(this.locationId);
    }
    get currentAction() {
        return this.actionQueue[0];
    }
    /** Moves this person to the Location specified, updation any current Location and the new Location objects as appropriate */
    goesTo(location, gridX, gridY) {
        var _a;
        const currentLocation = this.location;
        const newLocation = location instanceof import_manager_js_1.Location ? location : import_manager_js_1.Scene.byId(location);
        if (!newLocation) {
            throw new Error(`Invalid Location not provided - argument was ${location}`);
        }
        this.locationId = location instanceof import_manager_js_1.Location ? location.id : location;
        currentLocation === null || currentLocation === void 0 ? void 0 : currentLocation.removeRenderNode(this.currentRenderNode);
        currentLocation === null || currentLocation === void 0 ? void 0 : currentLocation.grid.removeThing(this);
        newLocation.addRenderNode(this.currentRenderNode);
        (_a = newLocation.grid.getSquare(gridX, gridY)) === null || _a === void 0 ? void 0 : _a.addThing(this);
        this.gridX = gridX;
        this.gridY = gridY;
        this.snapCurrentRenderNodeToGrid();
    }
    snapCurrentRenderNodeToGrid() {
        var _a, _b, _c, _d;
        this.currentRenderNode.setX(this.gridX * ((_b = (_a = this.location) === null || _a === void 0 ? void 0 : _a.gridSize) !== null && _b !== void 0 ? _b : 1));
        this.currentRenderNode.setY(this.gridY * ((_d = (_c = this.location) === null || _c === void 0 ? void 0 : _c.gridSize) !== null && _d !== void 0 ? _d : 1));
    }
    handleInput(input) {
        if (this.acceptingInput && (!this.currentAction || this.currentAction.complete)) {
            if (input.up.held) {
                this.direction = 'up';
                if (this.canWalkUp) {
                    this.walksUp();
                }
            }
            else if (input.down.held) {
                this.direction = 'down';
                if (this.canWalkDown) {
                    this.walksDown();
                }
            }
            else if (input.left.held) {
                this.direction = 'left';
                if (this.canWalkLeft) {
                    this.walksLeft();
                }
            }
            else if (input.right.held) {
                this.direction = 'right';
                if (this.canWalkRight) {
                    this.walksRight();
                }
            }
        }
    }
    /** Queue up an action */
    addAction(action) {
        this.actionQueue.push(action);
    }
    /** Queue up a list of actions (they will be in the order provided) */
    addActions(actions) {
        this.actionQueue.concat(actions);
    }
    walks(direction, squares = 1) {
        for (let i = 0; i < squares; i += 1) {
            this.addAction(new import_manager_js_1.Walk(this, direction));
        }
    }
    walksUp(squares = 1) {
        this.walks('up', squares);
        return this;
    }
    walksDown(squares = 1) {
        this.walks('down', squares);
        return this;
    }
    walksLeft(squares = 1) {
        this.walks('left', squares);
        return this;
    }
    walksRight(squares = 1) {
        this.walks('right', squares);
        return this;
    }
    canWalkTo(x, y) {
        var _a, _b, _c;
        return (_c = (_b = (_a = this.location) === null || _a === void 0 ? void 0 : _a.grid.getSquare(x, y)) === null || _b === void 0 ? void 0 : _b.walkable) !== null && _c !== void 0 ? _c : false;
    }
    get canWalkUp() {
        return this.canWalkTo(this.gridX, this.gridY - 1);
    }
    get canWalkDown() {
        return this.canWalkTo(this.gridX, this.gridY + 1);
    }
    get canWalkLeft() {
        return this.canWalkTo(this.gridX - 1, this.gridY);
    }
    get canWalkRight() {
        return this.canWalkTo(this.gridX + 1, this.gridY);
    }
    update(frameTimeStamp) {
        if (this.currentAction) {
            if (!this.currentAction.inProgress && !this.currentAction.complete) {
                this.currentAction.start();
            }
            if (this.currentAction.complete) {
                this.actionQueue.shift();
                this.update(frameTimeStamp);
            }
            else {
                this.currentAction.update(frameTimeStamp);
            }
        }
        else { // Idle
            this.currentRenderNode = this.renderNodes.standing[this.direction];
            this.snapCurrentRenderNodeToGrid();
        }
    }
    /** The current RenderNode always gets put in the Location of this Person */
    set currentRenderNode(node) {
        var _a, _b;
        if (this.currentRenderNodeId) {
            (_a = this.location) === null || _a === void 0 ? void 0 : _a.removeRenderNode(this.currentRenderNodeId);
        }
        if (node instanceof import_manager_js_1.RenderNode) {
            this.currentRenderNodeId = node.id;
        }
        else {
            this.currentRenderNodeId = node;
        }
        (_b = this.location) === null || _b === void 0 ? void 0 : _b.addRenderNode(this.currentRenderNodeId);
    }
    get currentRenderNode() {
        return (0, typescript_helpers_js_1.definitely)(import_manager_js_1.RenderNode.byId(this.currentRenderNodeId));
    }
}
exports.Person = Person;
Person.spriteOffsetX = -24;
Person.spriteOffsetY = -38;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGVyc29uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdGhpbmdzL3Blb3BsZS9QZXJzb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0RBQWlMO0FBQ2pMLDRFQUFxRTtBQXVCckUsTUFBYSxNQUFPLFNBQVEseUJBQUs7SUFnQjdCLFlBQVksSUFBZ0I7UUFDeEIsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBVGhCLFVBQUssR0FBVyxDQUFDLENBQUM7UUFDbEIsVUFBSyxHQUFXLENBQUMsQ0FBQztRQUVsQixtQkFBYyxHQUFZLEtBQUssQ0FBQztRQU81QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDaEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQzVCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUM5QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDaEMsSUFBSSxDQUFDLFdBQVcsR0FBRztZQUNmLFFBQVEsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDO1lBQy9DLE9BQU8sRUFBRSxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQztTQUN2RSxDQUFBO1FBQ0QsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDN0QsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUM7SUFDNUIsQ0FBQztJQUVPLG9CQUFvQixDQUFDLFNBQWlCO1FBQzFDLE1BQU0sUUFBUSxHQUFHLFVBQVUsSUFBSSxDQUFDLFNBQVMsSUFBSSxTQUFTLEVBQUUsQ0FB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QixFQUFFO1lBQzFCLE1BQUEsSUFBSSxDQUFDLFFBQVEsMENBQUUsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUE7U0FDNUQ7UUFDRCxJQUFJLElBQUksWUFBWSw4QkFBVSxFQUFFO1lBQzVCLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO1NBQ3RDO2FBQU07WUFDSCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO1NBQ25DO1FBQ0QsTUFBQSxJQUFJLENBQUMsUUFBUSwwQ0FBRSxhQUFhLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELElBQUksaUJBQWlCO1FBQ2pCLE9BQU8sSUFBQSxrQ0FBVSxFQUFDLDhCQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7SUFDakUsQ0FBQzs7QUF2TUwsd0JBd01DO0FBM0xrQixvQkFBYSxHQUFXLENBQUMsRUFBRSxDQUFDO0FBQzVCLG9CQUFhLEdBQVcsQ0FBQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUaGluZywgVGhpbmdEYXRhLCBBbmltYXRpb25Ob2RlLCBJbWFnZU5vZGUsIFNjZW5lSUQsIExvY2F0aW9uLCBTY2VuZSwgSW5wdXREYXRhLCBSZW5kZXJOb2RlSUQsIFJlbmRlck5vZGUsIEFjdGlvbiwgV2FsaywgV2Fsa0RpcmVjdGlvbiB9IGZyb20gJy4uLy4uL2ltcG9ydC1tYW5hZ2VyLmpzJztcclxuaW1wb3J0IHsgTWF5YmUsIGRlZmluaXRlbHkgfSBmcm9tICcuLi8uLi91dGlsL3R5cGVzY3JpcHQtaGVscGVycy5qcyc7XHJcblxyXG5leHBvcnQgdHlwZSBEaXJlY3Rpb24gPSAndXAnIHwgJ2Rvd24nIHwgJ2xlZnQnIHwgJ3JpZ2h0JztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGlyZWN0aW9uYWw8VD4ge1xyXG4gICAgdXA6IFQsXHJcbiAgICBkb3duOiBULFxyXG4gICAgbGVmdDogVCxcclxuICAgIHJpZ2h0OiBULFxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBlcnNvblJlbmRlck5vZGVzIHtcclxuICAgIHN0YW5kaW5nOiBEaXJlY3Rpb25hbDxJbWFnZU5vZGU+LFxyXG4gICAgd2Fsa2luZzogRGlyZWN0aW9uYWw8QW5pbWF0aW9uTm9kZT4sXHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIFBlcnNvbkRhdGEgPSBUaGluZ0RhdGEgJiB7XHJcbiAgICBmaXJzdE5hbWU6IHN0cmluZyxcclxuICAgIHN1cm5hbWU6IHN0cmluZyxcclxuICAgIGpvYlRpdGxlOiBzdHJpbmcsXHJcbiAgICBpbWdGb2xkZXI6IHN0cmluZyxcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFBlcnNvbiBleHRlbmRzIFRoaW5nIHtcclxuICAgIGZpcnN0TmFtZTogc3RyaW5nO1xyXG4gICAgc3VybmFtZTogc3RyaW5nO1xyXG4gICAgam9iVGl0bGU6IHN0cmluZztcclxuICAgIGltZ0ZvbGRlcjogc3RyaW5nO1xyXG4gICAgcmVuZGVyTm9kZXM6IFBlcnNvblJlbmRlck5vZGVzO1xyXG4gICAgZGlyZWN0aW9uOiBEaXJlY3Rpb247XHJcbiAgICBwcml2YXRlIGN1cnJlbnRSZW5kZXJOb2RlSWQ6IFJlbmRlck5vZGVJRDtcclxuICAgIGdyaWRYOiBudW1iZXIgPSAwO1xyXG4gICAgZ3JpZFk6IG51bWJlciA9IDA7XHJcbiAgICBwcml2YXRlIGxvY2F0aW9uSWQ6IE1heWJlPFNjZW5lSUQ+O1xyXG4gICAgYWNjZXB0aW5nSW5wdXQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgYWN0aW9uUXVldWU6IEFjdGlvbltdO1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgc3ByaXRlT2Zmc2V0WDogbnVtYmVyID0gLTI0O1xyXG4gICAgcHJpdmF0ZSBzdGF0aWMgc3ByaXRlT2Zmc2V0WTogbnVtYmVyID0gLTM4O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKGRhdGE6IFBlcnNvbkRhdGEpIHtcclxuICAgICAgICBzdXBlcihkYXRhKTtcclxuICAgICAgICB0aGlzLmZpcnN0TmFtZSA9IGRhdGEuZmlyc3ROYW1lO1xyXG4gICAgICAgIHRoaXMuc3VybmFtZSA9IGRhdGEuc3VybmFtZTtcclxuICAgICAgICB0aGlzLmpvYlRpdGxlID0gZGF0YS5qb2JUaXRsZTtcclxuICAgICAgICB0aGlzLmltZ0ZvbGRlciA9IGRhdGEuaW1nRm9sZGVyO1xyXG4gICAgICAgIHRoaXMucmVuZGVyTm9kZXMgPSB7XHJcbiAgICAgICAgICAgIHN0YW5kaW5nOiB0aGlzLm1ha2VEaXJlY3Rpb25hbEltYWdlKCdzdGFuZGluZycpLFxyXG4gICAgICAgICAgICB3YWxraW5nOiB0aGlzLm1ha2VEaXJlY3Rpb25hbEFuaW1hdGlvbignd2Fsa2luZycsIDY0LCA2NCwgMjAwLCB0cnVlKVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmN1cnJlbnRSZW5kZXJOb2RlSWQgPSB0aGlzLnJlbmRlck5vZGVzLnN0YW5kaW5nLmRvd24uaWQ7XHJcbiAgICAgICAgdGhpcy5hY3Rpb25RdWV1ZSA9IFtdO1xyXG4gICAgICAgIHRoaXMuZGlyZWN0aW9uID0gJ2Rvd24nO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbWFrZURpcmVjdGlvbmFsSW1hZ2UoaW1hZ2VUeXBlOiBzdHJpbmcpOiBEaXJlY3Rpb25hbDxJbWFnZU5vZGU+IHtcclxuICAgICAgICBjb25zdCBpbWdTdGFydCA9IGBwZW9wbGUvJHt0aGlzLmltZ0ZvbGRlcn0vJHtpbWFnZVR5cGV9YDtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB1cDogbmV3IEltYWdlTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tdS5wbmdgLCBvZmZzZXRYOiBQZXJzb24uc3ByaXRlT2Zmc2V0WCwgb2Zmc2V0WTogUGVyc29uLnNwcml0ZU9mZnNldFl9KSxcclxuICAgICAgICAgICAgZG93bjogbmV3IEltYWdlTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tZC5wbmdgLCBvZmZzZXRYOiBQZXJzb24uc3ByaXRlT2Zmc2V0WCwgb2Zmc2V0WTogUGVyc29uLnNwcml0ZU9mZnNldFl9KSxcclxuICAgICAgICAgICAgbGVmdDogbmV3IEltYWdlTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tbC5wbmdgLCBvZmZzZXRYOiBQZXJzb24uc3ByaXRlT2Zmc2V0WCwgb2Zmc2V0WTogUGVyc29uLnNwcml0ZU9mZnNldFl9KSwgICAgICAgICAgICBcclxuICAgICAgICAgICAgcmlnaHQ6IG5ldyBJbWFnZU5vZGUoe2ltYWdlTmFtZTogYCR7aW1nU3RhcnR9LXIucG5nYCwgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksICAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbWFrZURpcmVjdGlvbmFsQW5pbWF0aW9uKGFuaW1hdGlvblR5cGU6IHN0cmluZywgdzogbnVtYmVyLCBoOiBudW1iZXIsIGZyYW1lTWlsbGlzOiBudW1iZXIsIGxvb3BzOiBib29sZWFuID0gdHJ1ZSk6IERpcmVjdGlvbmFsPEFuaW1hdGlvbk5vZGU+IHtcclxuICAgICAgICBjb25zdCBpbWdTdGFydCA9IGBwZW9wbGUvJHt0aGlzLmltZ0ZvbGRlcn0vJHthbmltYXRpb25UeXBlfWA7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdXA6IG5ldyBBbmltYXRpb25Ob2RlKHtpbWFnZU5hbWU6IGAke2ltZ1N0YXJ0fS11LnBuZ2AsIHcsIGgsIGZyYW1lTWlsbGlzLCBsb29wcywgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksXHJcbiAgICAgICAgICAgIGRvd246IG5ldyBBbmltYXRpb25Ob2RlKHtpbWFnZU5hbWU6IGAke2ltZ1N0YXJ0fS1kLnBuZ2AsIHcsIGgsIGZyYW1lTWlsbGlzLCBsb29wcywgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGxlZnQ6IG5ldyBBbmltYXRpb25Ob2RlKHtpbWFnZU5hbWU6IGAke2ltZ1N0YXJ0fS1sLnBuZ2AsIHcsIGgsIGZyYW1lTWlsbGlzLCBsb29wcywgb2Zmc2V0WDogUGVyc29uLnNwcml0ZU9mZnNldFgsIG9mZnNldFk6IFBlcnNvbi5zcHJpdGVPZmZzZXRZfSksXHJcbiAgICAgICAgICAgIHJpZ2h0OiBuZXcgQW5pbWF0aW9uTm9kZSh7aW1hZ2VOYW1lOiBgJHtpbWdTdGFydH0tci5wbmdgLCB3LCBoLCBmcmFtZU1pbGxpcywgbG9vcHMsIG9mZnNldFg6IFBlcnNvbi5zcHJpdGVPZmZzZXRYLCBvZmZzZXRZOiBQZXJzb24uc3ByaXRlT2Zmc2V0WX0pLFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgbG9jYXRpb24oKTogTWF5YmU8TG9jYXRpb24+IHtcclxuICAgICAgICByZXR1cm4gU2NlbmUuYnlJZCh0aGlzLmxvY2F0aW9uSWQpIGFzIE1heWJlPExvY2F0aW9uPjtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY3VycmVudEFjdGlvbigpOiBNYXliZTxBY3Rpb24+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5hY3Rpb25RdWV1ZVswXTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogTW92ZXMgdGhpcyBwZXJzb24gdG8gdGhlIExvY2F0aW9uIHNwZWNpZmllZCwgdXBkYXRpb24gYW55IGN1cnJlbnQgTG9jYXRpb24gYW5kIHRoZSBuZXcgTG9jYXRpb24gb2JqZWN0cyBhcyBhcHByb3ByaWF0ZSAqL1xyXG4gICAgZ29lc1RvKGxvY2F0aW9uOiBMb2NhdGlvbiB8IFNjZW5lSUQsIGdyaWRYOiBudW1iZXIsIGdyaWRZOiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBjdXJyZW50TG9jYXRpb24gPSB0aGlzLmxvY2F0aW9uO1xyXG4gICAgICAgIGNvbnN0IG5ld0xvY2F0aW9uID0gbG9jYXRpb24gaW5zdGFuY2VvZiBMb2NhdGlvbiA/IGxvY2F0aW9uIDogU2NlbmUuYnlJZChsb2NhdGlvbikgYXMgTG9jYXRpb247XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCFuZXdMb2NhdGlvbikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgTG9jYXRpb24gbm90IHByb3ZpZGVkIC0gYXJndW1lbnQgd2FzICR7bG9jYXRpb259YCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmxvY2F0aW9uSWQgPSBsb2NhdGlvbiBpbnN0YW5jZW9mIExvY2F0aW9uID8gbG9jYXRpb24uaWQgOiBsb2NhdGlvbjtcclxuXHJcbiAgICAgICAgY3VycmVudExvY2F0aW9uPy5yZW1vdmVSZW5kZXJOb2RlKHRoaXMuY3VycmVudFJlbmRlck5vZGUpO1xyXG4gICAgICAgIGN1cnJlbnRMb2NhdGlvbj8uZ3JpZC5yZW1vdmVUaGluZyh0aGlzKTtcclxuXHJcbiAgICAgICAgbmV3TG9jYXRpb24uYWRkUmVuZGVyTm9kZSh0aGlzLmN1cnJlbnRSZW5kZXJOb2RlKTtcclxuICAgICAgICBuZXdMb2NhdGlvbi5ncmlkLmdldFNxdWFyZShncmlkWCwgZ3JpZFkpPy5hZGRUaGluZyh0aGlzKTtcclxuICAgICAgICB0aGlzLmdyaWRYID0gZ3JpZFg7XHJcbiAgICAgICAgdGhpcy5ncmlkWSA9IGdyaWRZO1xyXG4gICAgICAgIHRoaXMuc25hcEN1cnJlbnRSZW5kZXJOb2RlVG9HcmlkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc25hcEN1cnJlbnRSZW5kZXJOb2RlVG9HcmlkKCkge1xyXG4gICAgICAgIHRoaXMuY3VycmVudFJlbmRlck5vZGUuc2V0WCh0aGlzLmdyaWRYICogKHRoaXMubG9jYXRpb24/LmdyaWRTaXplID8/IDEpKTtcclxuICAgICAgICB0aGlzLmN1cnJlbnRSZW5kZXJOb2RlLnNldFkodGhpcy5ncmlkWSAqICh0aGlzLmxvY2F0aW9uPy5ncmlkU2l6ZSA/PyAxKSk7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgaGFuZGxlSW5wdXQoaW5wdXQ6IElucHV0RGF0YSkge1xyXG4gICAgICAgIGlmICh0aGlzLmFjY2VwdGluZ0lucHV0ICYmICghdGhpcy5jdXJyZW50QWN0aW9uIHx8IHRoaXMuY3VycmVudEFjdGlvbi5jb21wbGV0ZSkpIHtcclxuICAgICAgICAgICAgaWYgKGlucHV0LnVwLmhlbGQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlyZWN0aW9uID0gJ3VwJztcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbldhbGtVcCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMud2Fsa3NVcCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlucHV0LmRvd24uaGVsZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kaXJlY3Rpb24gPSAnZG93bic7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW5XYWxrRG93bikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMud2Fsa3NEb3duKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5wdXQubGVmdC5oZWxkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpcmVjdGlvbiA9ICdsZWZ0JztcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbldhbGtMZWZ0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy53YWxrc0xlZnQoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIGlmIChpbnB1dC5yaWdodC5oZWxkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpcmVjdGlvbiA9ICdyaWdodCc7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jYW5XYWxrUmlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLndhbGtzUmlnaHQoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogUXVldWUgdXAgYW4gYWN0aW9uICovXHJcbiAgICBhZGRBY3Rpb24oYWN0aW9uOiBBY3Rpb24pIHtcclxuICAgICAgICB0aGlzLmFjdGlvblF1ZXVlLnB1c2goYWN0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiogUXVldWUgdXAgYSBsaXN0IG9mIGFjdGlvbnMgKHRoZXkgd2lsbCBiZSBpbiB0aGUgb3JkZXIgcHJvdmlkZWQpICovXHJcbiAgICBhZGRBY3Rpb25zKGFjdGlvbnM6IEFjdGlvbltdKSB7XHJcbiAgICAgICAgdGhpcy5hY3Rpb25RdWV1ZS5jb25jYXQoYWN0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB3YWxrcyhkaXJlY3Rpb246IFdhbGtEaXJlY3Rpb24sIHNxdWFyZXM6IG51bWJlciA9IDEpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNxdWFyZXM7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICB0aGlzLmFkZEFjdGlvbihuZXcgV2Fsayh0aGlzLCBkaXJlY3Rpb24pKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgd2Fsa3NVcChzcXVhcmVzOiBudW1iZXIgPSAxKTogUGVyc29uIHtcclxuICAgICAgICB0aGlzLndhbGtzKCd1cCcsIHNxdWFyZXMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIHdhbGtzRG93bihzcXVhcmVzOiBudW1iZXIgPSAxKTogUGVyc29uIHtcclxuICAgICAgICB0aGlzLndhbGtzKCdkb3duJywgc3F1YXJlcyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgd2Fsa3NMZWZ0KHNxdWFyZXM6IG51bWJlciA9IDEpOiBQZXJzb24ge1xyXG4gICAgICAgIHRoaXMud2Fsa3MoJ2xlZnQnLCBzcXVhcmVzKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICB3YWxrc1JpZ2h0KHNxdWFyZXM6IG51bWJlciA9IDEpOiBQZXJzb24ge1xyXG4gICAgICAgIHRoaXMud2Fsa3MoJ3JpZ2h0Jywgc3F1YXJlcyk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjYW5XYWxrVG8oeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbj8uZ3JpZC5nZXRTcXVhcmUoeCwgeSk/LndhbGthYmxlID8/IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCBjYW5XYWxrVXAoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuV2Fsa1RvKHRoaXMuZ3JpZFgsIHRoaXMuZ3JpZFkgLSAxKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY2FuV2Fsa0Rvd24oKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuV2Fsa1RvKHRoaXMuZ3JpZFgsIHRoaXMuZ3JpZFkgKyAxKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY2FuV2Fsa0xlZnQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuV2Fsa1RvKHRoaXMuZ3JpZFggLSAxLCB0aGlzLmdyaWRZKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgY2FuV2Fsa1JpZ2h0KCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNhbldhbGtUbyh0aGlzLmdyaWRYICsgMSwgdGhpcy5ncmlkWSk7XHJcbiAgICB9XHJcblxyXG4gICAgb3ZlcnJpZGUgdXBkYXRlKGZyYW1lVGltZVN0YW1wOiBudW1iZXIpIHtcclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50QWN0aW9uKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jdXJyZW50QWN0aW9uLmluUHJvZ3Jlc3MgJiYgIXRoaXMuY3VycmVudEFjdGlvbi5jb21wbGV0ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QWN0aW9uLnN0YXJ0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEFjdGlvbi5jb21wbGV0ZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3Rpb25RdWV1ZS5zaGlmdCgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoZnJhbWVUaW1lU3RhbXApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50QWN0aW9uLnVwZGF0ZShmcmFtZVRpbWVTdGFtcCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgeyAvLyBJZGxlXHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFJlbmRlck5vZGUgPSB0aGlzLnJlbmRlck5vZGVzLnN0YW5kaW5nW3RoaXMuZGlyZWN0aW9uXTtcclxuICAgICAgICAgICAgdGhpcy5zbmFwQ3VycmVudFJlbmRlck5vZGVUb0dyaWQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIFRoZSBjdXJyZW50IFJlbmRlck5vZGUgYWx3YXlzIGdldHMgcHV0IGluIHRoZSBMb2NhdGlvbiBvZiB0aGlzIFBlcnNvbiAqL1xyXG4gICAgc2V0IGN1cnJlbnRSZW5kZXJOb2RlKG5vZGU6IFJlbmRlck5vZGUgfCBSZW5kZXJOb2RlSUQpIHtcclxuICAgICAgICBpZiAodGhpcy5jdXJyZW50UmVuZGVyTm9kZUlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9jYXRpb24/LnJlbW92ZVJlbmRlck5vZGUodGhpcy5jdXJyZW50UmVuZGVyTm9kZUlkKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobm9kZSBpbnN0YW5jZW9mIFJlbmRlck5vZGUpIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50UmVuZGVyTm9kZUlkID0gbm9kZS5pZDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRSZW5kZXJOb2RlSWQgPSBub2RlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxvY2F0aW9uPy5hZGRSZW5kZXJOb2RlKHRoaXMuY3VycmVudFJlbmRlck5vZGVJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0IGN1cnJlbnRSZW5kZXJOb2RlKCk6IFJlbmRlck5vZGUge1xyXG4gICAgICAgIHJldHVybiBkZWZpbml0ZWx5KFJlbmRlck5vZGUuYnlJZCh0aGlzLmN1cnJlbnRSZW5kZXJOb2RlSWQpKTtcclxuICAgIH1cclxufSJdfQ==